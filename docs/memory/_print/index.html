<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.79.1" /><link rel="canonical" type="text/html" href="https://jvmperf.net/docs/memory/">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Memory Analysis | jvmperf: Java Performance Workshop</title><meta property="og:title" content="Memory Analysis" />
<meta property="og:description" content="Analyzing the JVM heap with available tooling." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://jvmperf.net/docs/memory/" />
<meta property="og:site_name" content="jvmperf: Java Performance Workshop" />
<meta itemprop="name" content="Memory Analysis">
<meta itemprop="description" content="Analyzing the JVM heap with available tooling.">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Memory Analysis"/>
<meta name="twitter:description" content="Analyzing the JVM heap with available tooling."/>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-187218497-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






<link rel="preload" href="/scss/main.min.d365b133824fa7cc9e634c8a9ba97597f3759b03ad3fd78d42c3d136099b4543.css" as="style">
<link href="/scss/main.min.d365b133824fa7cc9e634c8a9ba97597f3759b03ad3fd78d42c3d136099b4543.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>



<link rel="stylesheet" href="/css/prism.css"/>



  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="font-weight-bold"><i class="fas fa-cube"></i>&nbsp;&nbsp;jvmperf</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/docs/" ><span class="active">Workshop</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a  class="nav-link" href="https://github.com/cchesser/java-perf-workshop/" target="_blank" ><span>GitHub</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link" href="/contributors/" ><span>Contributors</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site‚Ä¶"
  aria-label="Search this site‚Ä¶"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.e58fa4f6e97cd76ff2ec335879c50632.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/memory/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Memory Analysis</h1>
<div class="lead">Analyzing the JVM heap with available tooling.</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-b09263a61c61dd500a73a2e9c3ccb14a">Memory Heap Analysis</a></li>


    
  
    
    
	
<li>2: <a href="#pg-035a04a1e49235510f91d61520c4915c">Capturing Heap Dumps</a></li>


    
  
    
    
	
<li>3: <a href="#pg-1f3119da9a3dcd2385759ec01a852380">JOverflow</a></li>


    
  
    
    
	
<li>4: <a href="#pg-c01af137813ea12c96aaecbb0580e4ae">Eclipse MAT</a></li>


    
  
    
    
	
<li>5: <a href="#pg-de268a519541f36805c09c8812e06816">Visual VM</a></li>


    
  
    
    
	
<li>6: <a href="#pg-605fd19420eabae15eb4ac1d0e6b77d1">Memory Challenge</a></li>


    
  
    
    
	
<li>7: <a href="#pg-c6512c461f5f3bf1ba4ced486f736874">Garbage Collections</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b09263a61c61dd500a73a2e9c3ccb14a">1 - Memory Heap Analysis</h1>
    <div class="lead">Analyzing the heap of the JVM.</div>
	<p>In the following sections, we are going to do some analysis of the JVM&rsquo;s heap dump.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    Make sure you&rsquo;ve gone through the <a href="/docs/prereqs">Prerequisites</a>

</div>

<p>First, we&rsquo;ll need to capture a heap dump:</p>
<ul>
<li><a href="/docs/memory/capturing/">Capturing a Heap Dump</a></li>
</ul>
<p>We will then go through three common tools in which we can do some analysis of a heap dump. All of
which are free. üòÉ</p>
<ul>
<li><a href="/docs/memory/joverflow">JOverflow Analysis</a></li>
<li><a href="/docs/memory/mat">Eclipse MAT</a></li>
<li><a href="/docs/memory/visualvm">VisualVM</a></li>
</ul>
<p>We will then tie all our knowledge together and attempt to solve a quick challenge:</p>
<ul>
<li><a href="/docs/memory/challenge">Memory Challenge</a></li>
</ul>
<p>¬†</p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll learn how to acquire a Heap Dump.
</p>
        <a href="https://jvmperf.net/docs/memory/capturing/">Capturing Heap Dumps</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-035a04a1e49235510f91d61520c4915c">2 - Capturing Heap Dumps</h1>
    <div class="lead">Different ways to capture a heap dump.</div>
	<p>You may be aware by now, there are many different ways of getting data from the JVM. Here are just a few ways to get heap dump of the JVM.</p>
<h2 id="jcmd">jcmd</h2>
<p>With <code>jcmd</code>, you have the ability to invoke the <code>GC.heap_dump</code> command. This requires that you
are running as the same OS user as the target JVM process.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jcmd &lt;PID&gt; GC.heap_dump my_little_heap_dump.hprof
</code></pre></div><p><strong>Note:</strong> If a full path is not specified, the heap_dump will be created relative to the location from where the process was started (when generated with jcmd)</p>
<h2 id="jmap">jmap</h2>
<p>A more traditional approach is using <code>jmap</code> and invoking the command on the target process.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jmap -dump:format<span style="color:#ce5c00;font-weight:bold">=</span>b,file<span style="color:#ce5c00;font-weight:bold">=</span>my_little_heap_dump.hprof &lt;PID&gt;
</code></pre></div><h2 id="core-dump">Core Dump</h2>
<p>You can also use <code>jmap</code> to extract a heap dump from a core dump on the process:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo gdb --pid<span style="color:#ce5c00;font-weight:bold">=</span>&lt;PID&gt;
gcore /tmp/jvm.core
detach
quit
jmap -dump:format<span style="color:#ce5c00;font-weight:bold">=</span>b,file<span style="color:#ce5c00;font-weight:bold">=</span>my_little_heap_dump.hprof /usr/bin/java /tmp/jvm.core
</code></pre></div><p>üí° Capturing a heap dump from a core dump on Java 8, you may run into this issue:
<a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8073606">JDK-8073606</a>.</p>
<h3 id="hotspot-diagnostic-mbean">HotSpot Diagnostic MBean</h3>
<p>You can capture a heap dump by invoking a diagnostic MBean which is included in the Oracle JDK. You can do so by opening your favorite MBean browser (ex. <code>jconsole</code>, <code>jmc</code>) and invoke
the <code>com.sun.management.HotSpotDiagnostic</code>. The arguments are:</p>
<ul>
<li>Filename of the heap dump that will be created. üí° Note, it will be created with file ownership of the hosting JVM process.</li>
<li>Indicator to dump all live object (true will dump <strong>only live</strong> objects)</li>
</ul>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/hotspot_diag_mbean.png" alt="hotspot_diag"></p>
<p>¬†</p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll start analyzing our heap dump with JOverflow.
</p>
        <a href="https://jvmperf.net/docs/memory/joverflow/">JOverflow</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1f3119da9a3dcd2385759ec01a852380">3 - JOverflow</h1>
    <div class="lead">Heap Analysis using JOverflow</div>
	<p>Included in <a href="https://www.oracle.com/java/technologies/jdk-mission-control.html">JDK Mission Control</a> is a plugin that used to be a separate instance, the JOverflow Heap Analyzer. This plugin now adds a context menu selection to <strong>Dump Heap</strong> of JVMs from the JVM Browser.</p>
<p><img src="/joverflow/dump_heap.png" alt="joverflow dump heap"></p>
<p><strong>JOverflow</strong> is a great tool to start our analysis with since it is tailored to identifying common anti-patterns present in most heap dumps. This should give us an idea of the kinds of problems we can see in our JVMs.</p>
<p><img src="/joverflow/main_page.png" alt=""></p>
<h2 id="anti-patterns">Anti-Patterns</h2>
<p>Here is a listing of some the patterns that JOverflow identifies:</p>
<ul>
<li><strong>Empty Unused Collections</strong>: Empty collection, where modification <code>count == 0</code>.</li>
<li><strong>Empty Used Collections</strong>: Empty collection, where modification <code>count != 0</code>.</li>
<li><strong>Small Sparse</strong>: Only for array-based, where less than half the slots are occupied.
Small is considered: size &lt;= default (ex. 16 for HashMap).</li>
<li><strong>Large Sparse</strong>: Only for array-based, where less than half the slots are occupied.
Large is considered: Size &gt; default.</li>
<li><strong>Boxed</strong>: Contains boxed Numbers (ex. java.lang.Integer). Each of these boxed
number has overhead as compared to their primitive counterpart due to object references.</li>
<li><strong>Small Collections</strong>: Collections with 1 to 4 elements. There are fixed costs of collections, which may lend this
set of data better hosted in an array vs. a full Java collection type.</li>
<li><strong>Vertical Bar Collections</strong>: Collection which is a list of lists, where the outer collection
is large, and it&rsquo;s elements are all small collections (ex. List(1000) of List(100))</li>
<li><strong>Zero Size Arrays</strong>: Array where length == 0 (still consumers 12 - 16 bytes).</li>
<li><strong>Vertical Bar Arrays</strong>: Similar to <em>Vertical Bar Collections</em>, but for arrays.</li>
<li><strong>Sparse Arrays</strong>: Less than half of the elements are not null.</li>
<li><strong>Long Zero Tail Arrays</strong>: Ends with a consecutive series of zeros, where the tail length is &gt;= size / 2.</li>
<li><strong>Empty Arrays</strong>: Only null elements.</li>
<li><strong>Duplicate Arrays</strong>: Where an array contents are the same in another instance, but they are separate array instances.</li>
<li><strong>Duplicate Strings</strong>: Same as <em>Duplicate Array</em>, where <code>string1.equals(string2)</code> and <code>string1 != string2</code>.</li>
</ul>
<p>Reference: <a href="https://www.youtube.com/watch?v=b-mv9iWY8kw">JOverflow: Advanced Heap Analysis in Java Mission Control</a></p>
<h2 id="filtering">Filtering</h2>
<p>As you play with JOverflow, once you click on something, it will begin filtering down your content. If you wish to reduce down to code that you may own, you can start doing a package filter on the ancestor section.</p>
<p>In this example, I want to see duplicate strings for code under <code>cchesser</code>. In this case, I can see that our workshop service has several duplicate
strings (as this content is replicated on each object):</p>
<ul>
<li>Regular Session</li>
<li>4-Hour Workshop</li>
<li>8-Hour Workshop</li>
</ul>
<p>However, the number of instances / overhead is extremely low (since this is a small service), it gives you visibility of areas that you could optimize.</p>
<p><img src="/joverflow/duplicate_strings.png" alt="joverflow filter"></p>
<h3 id="navigating">Navigating</h3>
<p>Since JOverflow&rsquo;s mechanism of drilling down is by applying filters, it doesn&rsquo;t have an easy way to undo most operations, and instead relies on resetting the state to the unfiltered state. You can undo all operations by using the backwards arrow button:</p>
<p><img src="/joverflow/reset.png" alt="joverflow reset"></p>
<h2 id="instances">Instances</h2>
<p>We can also use the plugin to drill down a bit into particular instances.</p>
<p>We can enable the instances view by navigating to:</p>
<ol>
<li>Window &gt; Show View &gt; Other
<img src="/joverflow/window_showview_other.png" alt=""></li>
<li>Selecting JOverflow Instances
<img src="/joverflow/show_instances.png" alt=""></li>
</ol>
<h3 id="example---arrays-size-1">Example - Arrays Size 1</h3>
<p>In the following example, we&rsquo;re going to find:</p>
<ol>
<li>Arrays with One Element
<img src="/joverflow/arrays_one_element.png" alt=""></li>
<li>Coming from our WorkshopConfiguration
<img src="/joverflow/referrer_workshop_configuration.png" alt=""></li>
</ol>
<p>This should filter the Instances view down to that single object.</p>
<p><img src="/joverflow/config_instance.png" alt=""></p>
<h3 id="example---conference-session-details">Example - Conference Session Details</h3>
<p>We can use this same mechanism to also explore values of some of the classes we own, in the next example we&rsquo;re going to:</p>
<ol>
<li>Use All Objects of type Conference Session
<img src="/joverflow/conference_sessions.png" alt=""></li>
<li>Drill down into a couple of the instances
<img src="/joverflow/conference_session_instances.png" alt=""></li>
</ol>
<p>¬†</p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll continue our analysis in Eclipse MAT.
</p>
        <a href="https://jvmperf.net/docs/memory/mat/">Eclipse MAT</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c01af137813ea12c96aaecbb0580e4ae">4 - Eclipse MAT</h1>
    <div class="lead">Heap Analysis using Eclipse MAT</div>
	

<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    Make sure you&rsquo;ve gone through the <a href="/docs/prereqs">Prerequisites</a>

</div>

<p><a href="https://eclipse.org/mat/">Eclipse Memory Analyzer</a> is a fairly mature tool on analyzing heap dumps. It is a rich tool that includes the abilities to do OQL queries on the heap, general reporting on anti-patterns, and helpful common views (like the dominator tree). Eclipse Memory Analyzer tool is a separate install which can be a standalone install, or it can run as a plugin within Eclipse.</p>
<h2 id="opening-heap-dumps">Opening Heap Dumps</h2>
<p>After you have it installed, go to <strong>File</strong> and then <strong>Open Heap Dump&hellip;</strong> and specify the <code>hprof</code> file that you wish to analyze.</p>
<h3 id="index-files">Index Files</h3>
<p>üí° When Eclipse Memory Analyzer loads your <code>hprof</code> file, it will create many other index files to assist in optimally analyzing and navigating through your heap dump. It may make it easier to isolate your <code>prof</code> file in its own directory prior to opening it, based on the secondary files which are created. You can always just delete these files within Eclipse Memory Analyzer by opening the <strong>Heap Dump History</strong> window, right-clicking the <code>hprof</code> which was previously loaded, and selecting <strong>Delete Index Files</strong>. Example listing of index files which get generated by suffix:</p>
<ul>
<li><code>.domIn.index</code></li>
<li><code>.domOut.index</code></li>
<li><code>.index</code></li>
<li><code>.o2ret.index</code></li>
<li><code>.a2s.index</code></li>
<li><code>.idx.index</code></li>
<li><code>.inbound.index</code></li>
<li><code>.o2c.index</code></li>
<li><code>.o2hprof.index</code></li>
<li><code>.outbound.index</code></li>
<li><code>.threads</code></li>
</ul>
<h2 id="analyzing-the-heap-dump">Analyzing the Heap Dump</h2>
<p>In the following section, we&rsquo;ll go through a couple of the views and what sort of data we can gather from them.</p>
<h3 id="dominator-tree">Dominator Tree</h3>
<p>A common first area to look at your heap within Eclipse Memory Analyzer is the dominator tree. From the dominator tree, you can organize by the retained heap size, and then begin drilling down the tree to see the contributors to the largest GC roots.</p>
<p><img src="/mat/dominator_tree.png" alt=""></p>
<h3 id="histogram">Histogram</h3>
<p>The histogram gives you a quick listing of all the top consumers by type. Typically this is going to provide context of the large consumers based on their &ldquo;lower-level&rdquo; types. For example, <code>char[]</code> is a common large contributor, which then will be followed by <code>String</code> which is a type that is predominately weighted by the size of the <code>char[]</code>.</p>
<p><img src="/mat/histogram.png" alt=""></p>
<p>From the histogram, we can drill down into particular instances of an object and see what&rsquo;s referencing them by right clicking on a row and selecting <strong>List Objects</strong> &gt; <strong>with Incoming References</strong></p>
<p><img src="/mat/list_objects_menu.png" alt=""></p>
<p>This should let us drill down into an instance and find what exactly is holding on to that specific value:</p>
<p><img src="/mat/char_array_incoming_refs.png" alt=""></p>
<p>Since this view shows references by incoming link, we would read the results as:</p>
<p>&ldquo;angularjs&rdquo; is pointed to by the <code>[0]</code> index of the <code>tags</code> of a specific <code>ConferenceSession</code> instance, which is pointed to by <code>LocalCache</code>. Notice that this specific example is the inverse of what we found with the dominator tree, if we explored this table enough we would end up at a <code>ConferenceSessionLoader</code> reference.</p>
<h3 id="thread-overview">Thread Overview</h3>
<p>The thread overview is a helpful view when you are looking at contributors based on the execution of code. For example, if you have a JVM which has thrown an <code>OutOfMemoryError</code>, you can tell if some type of request caused a massive spike which caused the exhaustion of memory, or if the requests may have not been abnormal, there just wasn&rsquo;t sufficient space to support the request.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_thread_overview.png" alt="MAT Thread Overview"></p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    <p>It may be the case that the thread that has the OutOfMemoryError in its stack is not the root cause. Consider the following example:</p>
<ul>
<li>We have a max heap of 128 Mb.</li>
<li>A request comes in that produces a 125Mb <code>int[]</code></li>
<li>A second request comes in that produces a 5Mb <code>int[]</code>.</li>
</ul>
<p>The JVM would potentially throw the OutOfMemory on that second request, since there&rsquo;s not enough memory to allocate 5Mb, however, it might be the case that the code path for the initial request is allocating memory unnecessarily.</p>


</div>

<h3 id="oql">OQL</h3>
<p>Another strong feature of Eclipse Memory Analyzer is the OQL studio to execute queries to do lookup on objects in your heap.</p>
<p>Lookup our <code>ConferenceSession</code> class type:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">SELECT</span> <span style="color:#ce5c00;font-weight:bold">*</span>
<span style="color:#204a87;font-weight:bold">FROM</span> <span style="color:#000">INSTANCEOF</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConferenceSession</span>
</code></pre></div><p>üí° To execute the query, you click on the red exclamation mark (‚ùó). Alternatively, you can press <code>CTRL+Enter</code> on Windows or <code>Command+Enter</code> on macOS.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_oql_studio.png" alt="MAT OQL"></p>
<p>By returning the raw type back, you can expand each one to further look at the contents of the object. If you wanted to just report the object with its <code>title</code> attribute and the object&rsquo;s retained sized, you could do this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">SELECT</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">retainedHeapSize</span> 
<span style="color:#204a87;font-weight:bold">FROM</span> <span style="color:#000">INSTANCEOF</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConferenceSession</span> <span style="color:#204a87;font-weight:bold">c</span> 
</code></pre></div><p>Now, you could then filter this by including a <code>WHERE</code> clause, where you can filter it by
the title or the abstract:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">SELECT</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">retainedHeapSize</span> <span style="color:#204a87;font-weight:bold">FROM</span> <span style="color:#000">INSTANCEOF</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConferenceSession</span> <span style="color:#204a87;font-weight:bold">c</span> 
<span style="color:#204a87;font-weight:bold">WHERE</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">LIKE</span> <span style="color:#4e9a06">&#34;.*(J|j)ava.*&#34;</span> <span style="color:#204a87;font-weight:bold">OR</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abstract</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">LIKE</span> <span style="color:#4e9a06">&#34;.*(J|j)ava.*&#34;</span>
</code></pre></div><p>Reference: <a href="http://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Freference%2Foqlsyntax.html">Eclipse Memory Analyzer OQL Syntax</a></p>
<p>The auto-completion will also let you invoke fields and method&rsquo;s from Eclipse Mat&rsquo;s own <a href="https://wiki.eclipse.org/MemoryAnalyzer/Reading_Data_from_Heap_Dumps#The_object_model">internal model</a> for the heap dump. You can view other methods available by exploring the <a href="http://127.0.0.1:64030/help/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Fdoc%2Forg%2Feclipse%2Fmat%2Fsnapshot%2Fmodel%2FIObject.html">API Reference</a></p>
<p><img src="/mat/mat_oql_model_invocation.png" alt=""></p>
<h2 id="useful-plugins">Useful Plugins</h2>
<h3 id="calcite-mat">Calcite MAT</h3>
<p>The <a href="https://github.com/vlsi/mat-calcite-plugin">Calcite MAT Plugin</a> adds sort, group by and join behavior (among other things) and an additional SQL query engine.</p>
<p>We can use this plugin to do some more advanced analysis, for example:</p>
<ul>
<li>Getting a distribution of the number of tags in our ConferenceSessions</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000">getSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">tag_cnt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">getSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">))</span> 
<span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;cchesser.javaperf.workshop.data.ConferenceSession&#34;</span> <span style="color:#204a87;font-weight:bold">c</span> 
<span style="color:#204a87;font-weight:bold">group</span> <span style="color:#204a87;font-weight:bold">by</span> <span style="color:#000">tag_cnt</span> 
<span style="color:#204a87;font-weight:bold">order</span> <span style="color:#204a87;font-weight:bold">by</span> <span style="color:#000">tag_cnt</span> <span style="color:#204a87;font-weight:bold">desc</span>
</code></pre></div><p><img src="/mat/calcite_tag_distributions.png" alt=""></p>
<p>¬†</p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll continue our analysis in VisualVM.
</p>
        <a href="https://jvmperf.net/docs/memory/visualvm/">Visual VM</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-de268a519541f36805c09c8812e06816">5 - Visual VM</h1>
    <div class="lead">Heap Analysis using VisualVM</div>
	

<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    Make sure you&rsquo;ve gone through the <a href="/docs/prereqs">Prerequisites</a>

</div>

<p><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/visualvm/">VisualVM</a> is a tool which used to be part of Oracle&rsquo;s JDK and is now a <a href="https://visualvm.github.io/">standalone tool</a>. This tool was spawned from the <a href="https://profiler.netbeans.org/">Netbeans Profiler</a>, and it has some helpful tools to inspect a heap dump.</p>
<h2 id="opening-dumps">Opening Dumps</h2>
<p>To load the heap dump in VisualVM, you will just go to <strong>File</strong> -&gt; <strong>Load&hellip;</strong> and specify the
<strong>File Format</strong> to be <strong>Heap Dumps&hellip;</strong>.</p>
<p><img src="/visualvm/load_dump.png" alt=""></p>
<h2 id="analyzing-the-heap-dump">Analyzing the Heap Dump</h2>
<p>VisualVM offers the following sections:</p>
<ul>
<li>Summary</li>
<li>Objects</li>
<li>Threads</li>
<li>OQL Console</li>
<li>R Console</li>
</ul>
<p>For the purpose of this section we are only going to utilize the <strong>OQL Console</strong> to construct
queries on the heap. There are other options in VisualVM (briefly discussed here), but we feel that the other tools presented before this offer much nicer views/data.</p>
<h3 id="summary">Summary</h3>
<p>The <strong>Summary</strong> view gives you a quick overview of the state of the heap:</p>
<p><img src="/visualvm/summary.png" alt=""></p>
<p>This view also lets you quickly gather the dominators for the heap, similar to the Dominator Tree in Eclipse MAT.</p>
<p><img src="/visualvm/dominators.png" alt=""></p>
<h3 id="objects">Objects</h3>
<p>The <strong>Objects</strong> view groups instances by class.</p>
<p><img src="/visualvm/objects.png" alt=""></p>
<p>Within this view, you can inspect individual instances of an object and see both the fields and the incoming references to that instance:</p>
<p><img src="/visualvm/objects_expanded.png" alt=""></p>
<h3 id="threads">Threads</h3>
<p>The <strong>Threads</strong> view visualizes the state of threads.</p>
<p><img src="/visualvm/threads.png" alt=""></p>
<p>Within this view, you can drill down into certain threads and view what was specifically referenced in a stack frame:</p>
<p><img src="/visualvm/threads_expanded.png" alt=""></p>
<h3 id="oql-console">OQL Console</h3>
<p>One of the attractive features for VisualVM is that its <strong>OQL Console</strong> allows you to write Javascript code to query objects, which you can then do other functions on that data.</p>
<p>From the <strong>OQL Console</strong>, we will issue queries and then allow you to further play around with the language.</p>
<h2 id="oql-queries">OQL Queries</h2>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    The OQL which you use between this tool (and others), isn&rsquo;t necessarily <em>standard</em>, and therefore cannot be used between tooling without issues. VisualVM gives you
the ability to leverage Javascript, which is unique to other tools supporting heap dump analysis.

</div>

<p>Reference: <a href="https://htmlpreview.github.io/?https://raw.githubusercontent.com/visualvm/visualvm.java.net.backup/master/www/oqlhelp.html">VisualVM OQL Help</a></p>
<h3 id="deamon-threads">Deamon Threads</h3>
<p>Query for Thread objects which are daemons (you can get context of Threads, since they
are objects in your heap too):</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">select</span> <span style="color:#000">t</span> <span style="color:#000">from</span> <span style="color:#000">java</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lang</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Thread</span> <span style="color:#000">t</span> <span style="color:#000">where</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">daemon</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">true</span>
</code></pre></div><p>Previous versions of VisualVM used to return the results as hyperlinks, which you could then click
and begin diving into the instance state:</p>
<p><img src="/visualvm/oql_sample_results_links.png" alt=""></p>
<p>The newer versions of VisualVM will populate the results in a view similar to the <strong>Objects</strong> view:</p>
<p><img src="/visualvm/oql_sample_results.png" alt=""></p>
<h3 id="mapping-to-json">Mapping to JSON</h3>
<p>Query for Thread objects (similar to last query), but return multiple attributes as JSON:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">select</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thread_id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tid</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000">from</span> <span style="color:#000">java</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lang</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Thread</span> <span style="color:#000">t</span>
<span style="color:#000">where</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">daemon</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">true</span>
</code></pre></div><p><img src="/visualvm/sample_json_results.png" alt=""></p>
<h3 id="applying-javascript">Applying Javascript</h3>
<p>VisualVM offers a helper object that represents the heap, the <code>heap</code> object, which offers a few useful functions.</p>
<p><img src="/visualvm/oql_heap_object.png" alt=""></p>
<p>During our OQL searching, we&rsquo;ll be using <code>heap.objects</code> to gather the set of objects we want.</p>
<p>We&rsquo;ll start by limiting our objects to instances of <code>cchesser.javaperf.workshop.data.ConferenceSession</code> and assign it to a variable called <code>sessions</code> (which we&rsquo;ll reference later).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sessions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>We&rsquo;re going to find ConferenceSessions that which have <em>tags</em>, we&rsquo;ll do that by writing a Javascript function to filter results which have <em>tags</em>. We&rsquo;ll apply this filter to our <code>sessions</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sessions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sessions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><img src="/visualvm/oql_hasTags.png" alt=""></p>
<p>Take that previous query and further expand it to list it in JSON with the number of tags. It is often times convenient to have a reference to the object we&rsquo;re interacting with, to more easily see the available fields.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sessions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">withTags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sessions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">conference</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">conf</span> <span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tagCount</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">withTags</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><img src="/visualvm/oql_hasTags_json.png" alt=""></p>
<p>We can further expand this to sort the results, descending by number of tags, and list the tags in the results:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sessions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">withTags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sessions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">conference</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">conf</span> <span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tagCount</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">confs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">withTags</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">tagSorter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lhs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rhs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rhs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tagCount</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">lhs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tagCount</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">confs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tagSorter</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><img src="/visualvm/oql_tags_sorted.png" alt=""></p>
<p>We could also inline most of this using the inline syntax:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">hasTags</span><span style="color:#000;font-weight:bold">),</span> 
 <span style="color:#4e9a06">&#39;{ conference: it, tag_count: it.tags.size, tags: toArray(it.tags.elementData) }&#39;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#39;rhs.tag_count - lhs.tag_count&#39;</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p><img src="/visualvm/oql_tags_inline.png" alt=""></p>
<h2 id="useful-plugins">Useful Plugins</h2>
<h3 id="oql-syntax-support">OQL Syntax Support</h3>
<p>This plugin adds some auto complete and syntax highlighting to the OQL Console</p>
<p><img src="/visualvm/oql_syntax_plugin.png" alt=""></p>
<h2 id="i-classfas-fa-atlasi-challenge"><i class="fas fa-atlas"></i> Challenge</h2>
<p>Apply what you&rsquo;ve learned about OQL in this section and write some javascript that will show the distribution of tag counts in our conference sessions (similar to what we did with calcite mat.)</p>
<h3 id="sample-solutions">Sample Solutions</h3>
<h4 id="json-output">JSON Output</h4>
<p>This solution will return the result as a JSON object.</p>
<script>
    function toggleContent(button) {
        var content = button.parentElement.getElementsByClassName('spoiler-content')[0];
        content.hidden = !content.hidden;
    }
</script>
<div class="spoiler-container">
  <button onclick="toggleContent(this)">Show JSON</button>
  <div class="spoiler-content" hidden>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sessions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">conference</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">conf</span> <span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tagCount</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">confs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sessions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{}</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">arr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">toArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">confs</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000">arr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">conf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
  <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tagCount</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tagCount</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tagCount</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tagCount</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000">results</span>
</code></pre></div><p><img src="/visualvm/tag_distributions_json.png" alt=""></p>
  </div>
</div>
<h4 id="html-output">HTML Output</h4>
<p>This solution will return the result as an HTML <code>&lt;ul&gt;</code>.</p>
<script>
    function toggleContent(button) {
        var content = button.parentElement.getElementsByClassName('spoiler-content')[0];
        content.hidden = !content.hidden;
    }
</script>
<div class="spoiler-container">
  <button onclick="toggleContent(this)">Show HTML</button>
  <div class="spoiler-content" hidden>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sessions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">conference</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">conf</span> <span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tagCount</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">confs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sessions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">toJSON</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">arr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">toArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">confs</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">maxSize</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;it.tagCount&#39;</span><span style="color:#000;font-weight:bold">))</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span>
<span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">maxSize</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">conf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
  <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">conf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tagCount</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">++</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">report</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&lt;html&gt;&lt;ul&gt;&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">maxSize</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
  <span style="color:#000">report</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#4e9a06">&#34;&lt;li&gt;&lt;b&gt;Size(&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#4e9a06">&#34;)&lt;/b&gt;=&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">count</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#4e9a06">&#34;&lt;/li&gt;&#34;</span> 
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000">report</span><span style="color:#ce5c00;font-weight:bold">+=</span><span style="color:#4e9a06">&#34;&lt;/ul&gt;&lt;/html&gt;&#34;</span>
<span style="color:#000">toHtml</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">report</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p><img src="/visualvm/tag_distributions_html.png" alt=""></p>
  </div>
</div>
<p>¬†</p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll test our knwolege.
</p>
        <a href="https://jvmperf.net/docs/memory/challenge/">Memory Challenge</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-605fd19420eabae15eb4ac1d0e6b77d1">6 - Memory Challenge</h1>
    <div class="lead">Put all the pieces together with this challenge to test your skills</div>
	<p>The provided WorkshopService has an intentional memory problem, use the previous sections as reference to try to pin point it.</p>
<h2 id="tips">Tips</h2>
<ul>
<li>With the Dominator Tree (Eclipse MAT) determine what object would free up the most memory (if we could get rid of it)</li>
<li>With the Histogram (Eclipse MAT) determine what type of object has the most instances
<ul>
<li>Using the Incoming Objects view, find out what&rsquo;s pointing to them.</li>
</ul>
</li>
</ul>
<p>Once you&rsquo;ve found the large object, look through it&rsquo;s properties and determine why this object holds on to so many other objects.</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Solution</h4>

    This section contains a solution, make sure you&rsquo;ve given things a shot before spoiling the fun.

</div>

<script>
    function toggleContent(button) {
        var content = button.parentElement.getElementsByClassName('spoiler-content')[0];
        content.hidden = !content.hidden;
    }
</script>
<div class="spoiler-container">
  <button onclick="toggleContent(this)">Show Solution</button>
  <div class="spoiler-content" hidden>
<h2 id="dominator-tree">Dominator Tree</h2>
<p>A first glance at the dominator tree will point us to a <code>io.dropwizard.jetty.MutableServletContextHandler</code>, which is something controlled by the DropWizard framework. Let&rsquo;s dig through its references until we find some classes in the <code>cchesser</code> package.</p>
<p><img src="/mem_challenge/dominator_tree_start.png" alt=""></p>
<p>The first instance of a class we &ldquo;own&rdquo; is <code>cchesser.javaperf.workshop.resources.WorkshopResource</code></p>
<p><img src="/mem_challenge/dominator_tree_resource.png" alt=""></p>
<p>Let&rsquo;s look at it&rsquo;s properties a bit, and we&rsquo;ll find a <code>cchesser.javaperf.workshop.cache.CleverCache</code> reference with about 70% of the memory consumption.</p>
<p><img src="/mem_challenge/dominator_tree_clever_cache.png" alt=""></p>
<p>We&rsquo;ll look at its properties in a bit more detail in the following sections.</p>
<h2 id="histogram-view">Histogram View</h2>
<p>A first glance at the Histogram View (sorted by retained heap), shows us about 2,000,000 instances of <code>cchesser.javaperf.workshop.data.Searcher$SearchResultElement</code></p>
<p><img src="/mem_challenge/histogram.png" alt=""></p>
<p>Looking through the references to an instance of this type, we end up being referenced by the <code>data</code> field in <code>cchesser.javaperf.workshop.cache.CleverCache$CacheEntry</code></p>
<p><img src="/mem_challenge/sre_incoming_refs.png" alt=""></p>
<p>We can further inspect the Incoming References for a particular entry, and see what is pointing to it, tracing it back to something we own:</p>
<p><img src="/mem_challenge/cc_entry_incoming_refs.png" alt=""></p>
<p>Once again, we&rsquo;ve ended up at <code>cchesser.javaperf.workshop.resources.WorkshopResource</code>, specifically a field called <code>resultsByContext</code>.</p>
<p>We&rsquo;ll take a closer look at this <code>cchesser.javaperf.workshop.cache.CleverCache</code> object.</p>
<h2 id="inspecting-clever-cache">Inspecting Clever Cache</h2>
<p>First, lets determine how many instances of <code>cchesser.javaperf.workshop.cache.CleverCache</code> we have. We&rsquo;ve found a single instance that is about 70Mb (in our sample dump), so let&rsquo;s double check if there&rsquo;s more of these.</p>
<p>We can do that in a couple of ways:</p>
<ol>
<li>Use the histogram view to filter on <code>CleverCache</code></li>
</ol>
<p><img src="/mem_challenge/mat_clevercache_instance.png" alt=""></p>
<ol start="2">
<li>Use OQL to find instances of that object:</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">select</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CleverCache</span>
</code></pre></div><p><img src="/mem_challenge/mat_oql_clevercache.png" alt=""></p>
<h3 id="fieldsreferences">Fields/References</h3>
<p>We can find the fields and references for an instance using either Eclipse MAT or VisualVM.</p>
<p>In Eclipse Mat, the fields for an instance display in an <strong>Attributes</strong> tab</p>
<p><img src="/mem_challenge/mat_cc_instance.png" alt=""></p>
<p>In VisualVM, we can load the <strong>Objects</strong> view and apply a filter on class name to then inspect the fields and references</p>
<p><img src="/mem_challenge/visualvm_cc_instance.png" alt=""></p>
<p>Looking at the properties, we find that there&rsquo;s a <code>cacheLimit</code> of <code>250</code>. Let&rsquo;s find out exactly how many entries are in the cache (the <code>innerCache</code> field).</p>
<h2 id="finding-sizes">Finding Sizes</h2>
<p>Let&rsquo;s write a query that will show us what the count of entries in the cache is.</p>
<ul>
<li>For our query, we need to pull the <code>cacheLimit</code> and <code>size</code> of the <code>innerCache</code> map,</li>
</ul>
<p>We can do this a few ways:</p>
<h3 id="eclipse-mat--oql">Eclipse MAT / OQL</h3>
<p>we can do that with the following query:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">SELECT</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheLimit</span> <span style="color:#204a87;font-weight:bold">AS</span> <span style="color:#4e9a06">&#34;max entries&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">innerCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">size</span> <span style="color:#204a87;font-weight:bold">AS</span> <span style="color:#000">entries</span> <span style="color:#204a87;font-weight:bold">FROM</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CleverCache</span> <span style="color:#204a87;font-weight:bold">c</span> 
</code></pre></div><p><img src="/mem_challenge/oql_size_report.png" alt=""></p>
<h3 id="eclipse-mat--calcite">Eclipse MAT / Calcite</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">select</span> <span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheLimit</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#4e9a06">&#34;max entries&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">getSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">innerCache</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#4e9a06">&#34;entries&#34;</span> 
<span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">cchesser</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">javaperf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workshop</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CleverCache</span> <span style="color:#204a87;font-weight:bold">c</span>
</code></pre></div><p><img src="/mem_challenge/calcite_size_report.png" alt=""></p>
<h3 id="visualvm--oql">VisualVM / OQL</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">caches</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">heap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objects</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cchesser.javaperf.workshop.cache.CleverCache&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">report</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">maxEntries</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheLimit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">entries</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">innerCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
 
<span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">caches</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">report</span><span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p><img src="/mem_challenge/visualvm_size_report.png" alt=""></p>
<div class="pageinfo pageinfo-warning">
<p>That doesn&rsquo;t seem right at all, we want at most 250 items but we have about 10,000. Let&rsquo;s find out why that is the case.</p>
</div>
<h2 id="memory-problem-explained">Memory Problem Explained</h2>
<p>The interaction between the <code>WorkshopResource</code> and <code>CleverCache</code> happens through the <code>/search</code> resource.</p>
<p><em>cchesser.javaperf.workshop.WorkshopResource</em></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@GET</span>
<span style="color:#5c35cc;font-weight:bold">@Path</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/search&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Produces</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MediaType</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">APPLICATION_JSON</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#5c35cc;font-weight:bold">@Timed</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Searcher</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">SearchResult</span> <span style="color:#000">searchConference</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@QueryParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;q&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">term</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#5c35cc;font-weight:bold">@QueryParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;c&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fetchResults</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">term</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">);</span>
<span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Searcher</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">SearchResult</span> <span style="color:#000">fetchResults</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">term</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
  
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">context</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">isEmpty</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">resultsByContext</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">exists</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">resultsByContext</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">fetch</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">);</span>
      <span style="color:#ce5c00;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// does not exist in cache, compute and store
</span><span style="color:#8f5902;font-style:italic"></span>  
  <span style="color:#000">SearchResult</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">searcher</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">search</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">term</span><span style="color:#ce5c00;font-weight:bold">);</span>
  <span style="color:#000">resultsByContext</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">store</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">results</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getResultsContext</span><span style="color:#ce5c00;font-weight:bold">(),</span> <span style="color:#000">results</span><span style="color:#ce5c00;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">results</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>If a context is sent, the previously cached values for the search are returned, otherwise we cache those result values in case they need to be referenced again.</p>
<p><em>javaperf.workshop.cache.CleverCache</em></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">  * Stores the given key value pair in the cache
</span><span style="color:#8f5902;font-style:italic">  *
</span><span style="color:#8f5902;font-style:italic">  * @param key   the unique identifier associated with the given value
</span><span style="color:#8f5902;font-style:italic">  * @param value the value mapped to the given key
</span><span style="color:#8f5902;font-style:italic">  */</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">store</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">K</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">V</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">isFull</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">K</span> <span style="color:#000">keyToRemove</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getLFUKey</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#000">CleverCache</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">K</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">V</span><span style="color:#ce5c00;font-weight:bold">&gt;.</span><span style="color:#c4a000">CacheEntry</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">V</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">removedEntry</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">innerCache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">remove</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">keyToRemove</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#000">CacheEntry</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">V</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">newEntry</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">CacheEntry</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">V</span><span style="color:#ce5c00;font-weight:bold">&gt;();</span>
    <span style="color:#000">newEntry</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#000">newEntry</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">frequency</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#000">innerCache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">newEntry</span><span style="color:#ce5c00;font-weight:bold">);</span>
  <span style="color:#ce5c00;font-weight:bold">}</span>
  <span style="color:#8f5902;font-style:italic">// other methods
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">isFull</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">innerCache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">size</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">cacheLimit</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>This interaction is <strong>NOT</strong> thread safe. Consider this scenario:</p>
<ul>
<li>Thread 1 invokes <code>store</code> when the <code>innerCache.size()</code> is <code>249</code>
<ul>
<li><code>isFull()</code> evaluates to <code>false</code></li>
<li>Execution halts prior to <code>innerCache.put</code></li>
</ul>
</li>
<li>Thread 2 invokes <code>store</code> when the <code>innerCache.size()</code> is <code>249</code>
<ul>
<li><code>isFull()</code> evaluates to false</li>
<li>Execution halts prior to <code>innerCache.put</code></li>
</ul>
</li>
<li>Thread 1 resumes and executes <code>innerCache.put</code>, <code>innerCache.size()</code> is now <code>250</code></li>
<li>Thread 2 resumes and executes <code>innerCache.put</code>, <code>innerCache.size()</code> is now <code>251</code></li>
<li>For the lifecycle of the jvm <code>isFull()</code> will no longer return <code>true</code></li>
</ul>
<p>Fortunately, the DropWizard documentation calls out the need to consider thread safety:</p>
<p><img src="/mem_challenge/dw_thread_safety.png" alt=""></p>
<p>Since the <code>WorkshopResource</code> has a <code>resultsByContext</code> field that will get shared across threads, that type should be thread safe.</p>
<h3 id="potential-solutions">Potential Solutions</h3>
<ul>
<li>
<p>The naive solution would be to just change <code>isFull()</code> to consider <code>&gt;=</code>, though that might lead to ConcurrentModificationExceptions</p>
</li>
<li>
<p>The proper solution would be to make the class Thread Safe</p>
</div>
</li>
</ul>
</div>
<p>¬†</p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll continue learn about Garbage Collection logs.
</p>
        <a href="https://jvmperf.net/docs/memory/gc/">Garbage Collections</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c6512c461f5f3bf1ba4ced486f736874">7 - Garbage Collections</h1>
    <div class="lead">Analyzing garbage collections of the JVM</div>
	<p>A key piece to understanding what is happening in terms of GC cycles within your service,
is enabling GC logs. In this section, we are going to do some analysis on the JVM in regards to it&rsquo;s garbage collection (GC)
cycles.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Prerequisite</h4>

    <a href="https://www.r-project.org/">R environment</a> <em>(If you want to try parsing some of the logs)</em>

</div>

<h2 id="gc-jvm-options">GC JVM Options</h2>
<p>Here is a set of JVM options you can enable on your service and how to interpret those logs.</p>
<ul>
<li><code>-XX:+PrintGCDetails</code>: Includes more details within your GC log</li>
<li><code>-XX:+PrintGCDateStamps</code>: Have a readable date/time string to correlate events in your log. Without
this option, your GC log will have elapsed time since the JVM was started. This format (which is reported)
in seconds (with millisecond precision), is not easy for someone to quickly correlate when this event was
logged (as you have to infer the time based on when the JVM was started).</li>
<li><code>-Xloggc</code>: Specifies the log file for the garbage collection logs (otherwise will go to stdout).
üí° Note: <code>-verbose:gc</code> is NOT necessary when you set <code>Xloggc</code> (it is implied).</li>
<li><code>-XX:+UseGCLogFileRotation</code>: Support rotating your GC log file (you don&rsquo;t want to let this get too
big).</li>
<li><code>-XX:GCLogFileSize</code>: Size of the file for rotation (ex. <code>10M</code>).</li>
<li><code>-XX:NumberOfGCLogFiles</code>: Number of GC log files to maintain (ex. <code>3</code>). üí° Note: if you are monitoring
your log file with another solution (like <a href="http://www.splunk.com/">splunk</a> or
<a href="https://www.elastic.co/products/logstash">logstash</a>), you typically don&rsquo;t need to be keeping an inventory of
rolled files around, unless you are concerned about log forwarding failing and want to ensure a given amount
is still capable of being captured from a host.</li>
</ul>
<h2 id="gc-log-formats">GC Log formats</h2>
<p>With different garbage collectors in the JVM, you will get slightly different GC log formats.</p>
<h3 id="parallel-gc">Parallel GC</h3>
<pre><code>2015-09-30T10:57:20.215+0600: 0.847: [GC (Allocation Failure) [PSYoungGen: 65536K-&gt;10748K(76288K)] 65536K-&gt;12607K(251392K), 0.0118637 secs] [Times: user=0.03 sys=0.01, real=0.01 secs]
2015-09-30T10:57:20.556+0600: 1.188: [GC (Metadata GC Threshold) [PSYoungGen: 44312K-&gt;10748K(141824K)] 46171K-&gt;12786K(316928K), 0.0077755 secs] [Times: user=0.03 sys=0.00, real=0.01 secs]
2015-09-30T10:57:20.564+0600: 1.196: [Full GC (Metadata GC Threshold) [PSYoungGen: 10748K-&gt;0K(141824K)] [ParOldGen: 2038K-&gt;10444K(116736K)] 12786K-&gt;10444K(258560K), [Metaspace: 20976K-&gt;20976K(1067008K)], 0.0286381 secs] [Times: user=0.14 sys=0.01, real=0.03 secs]
</code></pre><h3 id="concurrent-mark-sweep">Concurrent Mark Sweep</h3>
<pre><code>2015-09-30T11:11:35.994+0600: 0.838: [GC (Allocation Failure) 0.838: [ParNew: 69952K-&gt;8703K(78656K), 0.0128204 secs] 69952K-&gt;12781K(253440K), 0.0128848 secs] [Times: user=0.04 sys=0.01, real=0.01 secs]
2015-09-30T11:11:38.009+0600: 2.853: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4077K(174784K)] 67493K(253440K), 0.0088311 secs] [Times: user=0.04 sys=0.00, real=0.01 secs]
2015-09-30T11:11:38.018+0600: 2.862: [CMS-concurrent-mark-start]
2015-09-30T11:11:38.018+0600: 2.862: [CMS-concurrent-mark: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
2015-09-30T11:11:38.018+0600: 2.862: [CMS-concurrent-preclean-start]
2015-09-30T11:11:38.019+0600: 2.863: [CMS-concurrent-preclean: 0.001/0.001 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]
2015-09-30T11:11:38.019+0600: 2.863: [CMS-concurrent-abortable-preclean-start]
 CMS: abort preclean due to time 2015-09-30T11:11:43.074+0600: 7.918: [CMS-concurrent-abortable-preclean: 1.233/5.055 secs] [Times: user=1.23 sys=0.01, real=5.06 secs]
2015-09-30T11:11:43.074+0600: 7.918: [GC (CMS Final Remark) [YG occupancy: 63415 K (78656 K)]7.918: [Rescan (parallel) , 0.0052614 secs]7.924: [weak refs processing, 0.0000337 secs]7.924: [class unloading, 0.0029068 secs]7.927: [scrub symbol table, 0.0025781 secs]7.929: [scrub string table, 0.0002699 secs][1 CMS-remark: 4077K(174784K)] 67493K(253440K), 0.0117740 secs] [Times: user=0.04 sys=0.01, real=0.01 secs]
2015-09-30T11:11:43.086+0600: 7.930: [CMS-concurrent-sweep-start]
2015-09-30T11:11:43.086+0600: 7.930: [CMS-concurrent-sweep: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
2015-09-30T11:11:43.087+0600: 7.930: [CMS-concurrent-reset-start]
2015-09-30T11:11:43.110+0600: 7.954: [CMS-concurrent-reset: 0.023/0.023 secs] [Times: user=0.01 sys=0.01, real=0.03 secs]
</code></pre><h3 id="g1">G1</h3>
<pre><code>015-09-30T11:13:03.870+0600: 0.395: [GC pause (G1 Evacuation Pause) (young), 0.0052206 secs]
   [Parallel Time: 1.9 ms, GC Workers: 8]
      [GC Worker Start (ms): Min: 395.4, Avg: 395.5, Max: 395.8, Diff: 0.3]
      [Ext Root Scanning (ms): Min: 0.0, Avg: 0.3, Max: 1.1, Diff: 1.1, Sum: 2.0]
      [Update RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]
         [Processed Buffers: Min: 0, Avg: 0.0, Max: 0, Diff: 0, Sum: 0]
      [Scan RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [Code Root Scanning (ms): Min: 0.0, Avg: 0.1, Max: 0.4, Diff: 0.4, Sum: 0.5]
      [Object Copy (ms): Min: 0.7, Avg: 1.4, Max: 1.6, Diff: 0.9, Sum: 11.4]
      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [GC Worker Total (ms): Min: 1.5, Avg: 1.8, Max: 1.8, Diff: 0.3, Sum: 14.2]
      [GC Worker End (ms): Min: 397.3, Avg: 397.3, Max: 397.3, Diff: 0.0]
   [Code Root Fixup: 0.1 ms]
   [Code Root Purge: 0.1 ms]
   [Clear CT: 0.1 ms]
   [Other: 3.0 ms]
      [Choose CSet: 0.0 ms]
      [Ref Proc: 2.7 ms]
      [Ref Enq: 0.0 ms]
      [Redirty Cards: 0.2 ms]
      [Humongous Reclaim: 0.0 ms]
      [Free CSet: 0.0 ms]
   [Eden: 24.0M(24.0M)-&gt;0.0B(39.0M) Survivors: 0.0B-&gt;3072.0K Heap: 24.0M(256.0M)-&gt;5754.5K(256.0M)]
 [Times: user=0.02 sys=0.01, real=0.00 secs]
2015-09-30T11:13:04.343+0600: 0.868: [GC pause (G1 Evacuation Pause) (young), 0.0082908 secs]
   [Parallel Time: 5.1 ms, GC Workers: 8]
      [GC Worker Start (ms): Min: 868.3, Avg: 868.4, Max: 868.8, Diff: 0.5]
      [Ext Root Scanning (ms): Min: 0.0, Avg: 0.3, Max: 1.7, Diff: 1.7, Sum: 2.7]
      [Update RS (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 0.5]
         [Processed Buffers: Min: 0, Avg: 0.4, Max: 1, Diff: 1, Sum: 3]
      [Scan RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [Code Root Scanning (ms): Min: 0.0, Avg: 0.4, Max: 1.4, Diff: 1.4, Sum: 3.5]
      [Object Copy (ms): Min: 3.2, Avg: 4.0, Max: 4.6, Diff: 1.4, Sum: 32.1]
      [Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.1, Diff: 0.1, Sum: 0.6]
      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [GC Worker Total (ms): Min: 4.6, Avg: 4.9, Max: 5.0, Diff: 0.5, Sum: 39.5]
      [GC Worker End (ms): Min: 873.3, Avg: 873.3, Max: 873.4, Diff: 0.0]
   [Code Root Fixup: 0.3 ms]
   [Code Root Purge: 0.1 ms]
   [Clear CT: 0.1 ms]
   [Other: 2.7 ms]
      [Choose CSet: 0.0 ms]
      [Ref Proc: 2.4 ms]
      [Ref Enq: 0.0 ms]
      [Redirty Cards: 0.1 ms]
      [Humongous Reclaim: 0.0 ms]
      [Free CSet: 0.1 ms]
   [Eden: 39.0M(39.0M)-&gt;0.0B(147.0M) Survivors: 3072.0K-&gt;6144.0K Heap: 44.6M(256.0M)-&gt;13.9M(256.0M)]
 [Times: user=0.04 sys=0.00, real=0.01 secs]
2015-09-30T11:13:04.650+0600: 1.176: [GC pause (Metadata GC Threshold) (young) (initial-mark), 0.0090083 secs]
   [Parallel Time: 5.5 ms, GC Workers: 8]
      [GC Worker Start (ms): Min: 1175.9, Avg: 1176.0, Max: 1176.0, Diff: 0.1]
      [Ext Root Scanning (ms): Min: 1.1, Avg: 1.2, Max: 1.4, Diff: 0.3, Sum: 9.4]
      [Update RS (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 1.2]
         [Processed Buffers: Min: 0, Avg: 1.1, Max: 2, Diff: 2, Sum: 9]
      [Scan RS (ms): Min: 0.1, Avg: 0.1, Max: 0.3, Diff: 0.2, Sum: 1.1]
      [Code Root Scanning (ms): Min: 0.0, Avg: 0.2, Max: 0.5, Diff: 0.5, Sum: 2.0]
      [Object Copy (ms): Min: 3.4, Avg: 3.7, Max: 3.8, Diff: 0.4, Sum: 29.3]
      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]
      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.2]
      [GC Worker Total (ms): Min: 5.4, Avg: 5.4, Max: 5.5, Diff: 0.1, Sum: 43.3]
      [GC Worker End (ms): Min: 1181.4, Avg: 1181.4, Max: 1181.4, Diff: 0.0]
   [Code Root Fixup: 0.3 ms]
   [Code Root Purge: 0.0 ms]
   [Clear CT: 0.1 ms]
   [Other: 3.0 ms]
      [Choose CSet: 0.0 ms]
      [Ref Proc: 2.7 ms]
      [Ref Enq: 0.0 ms]
      [Redirty Cards: 0.1 ms]
      [Humongous Reclaim: 0.0 ms]
      [Free CSet: 0.1 ms]
   [Eden: 33.0M(147.0M)-&gt;0.0B(140.0M) Survivors: 6144.0K-&gt;13.0M Heap: 46.9M(256.0M)-&gt;20.9M(256.0M)]
 [Times: user=0.04 sys=0.00, real=0.01 secs]
2015-09-30T11:13:04.660+0600: 1.185: [GC concurrent-root-region-scan-start]
2015-09-30T11:13:04.664+0600: 1.190: [GC concurrent-root-region-scan-end, 0.0046509 secs]
2015-09-30T11:13:04.664+0600: 1.190: [GC concurrent-mark-start]
2015-09-30T11:13:04.665+0600: 1.190: [GC concurrent-mark-end, 0.0007287 secs]
2015-09-30T11:13:04.665+0600: 1.190: [GC remark 1.190: [Finalize Marking, 0.0001736 secs] 1.191: [GC ref-proc, 0.0000411 secs] 1.191: [Unloading, 0.0016740 secs], 0.0020377 secs]
 [Times: user=0.01 sys=0.00, real=0.00 secs]
2015-09-30T11:13:04.667+0600: 1.193: [GC cleanup 21M-&gt;14M(256M), 0.0004254 secs]
 [Times: user=0.01 sys=0.00, real=0.00 secs]
</code></pre><h2 id="type-of-collections">Type of Collections</h2>
<p>A simple rule to watch for on your logs is the prefix of either:</p>
<pre><code>[GC ...      &lt;- Minor GC cycle (young gen)
[Full GC ... &lt;- Full GC cycle
</code></pre><p>(‚ùó) Explicit GCs can also be identified, which is when something is invoking the <code>System.gc()</code> API. Note, this is not good thing, as
something is forcing a GC cycle to occur, rather than letting the JVM trigger this on its own (what should naturally occur).</p>
<pre><code>2015-09-30T12:23:44.425+0600: 195.699: [GC (System.gc()) [PSYoungGen: 39223K-&gt;3562K(76288K)] 49685K-&gt;14032K(190464K), 0.0047880 secs] [Times: user=0.02 sys=0.00, real=0.01 secs]
2015-09-30T12:23:44.430+0600: 195.704: [Full GC (System.gc()) [PSYoungGen: 3562K-&gt;0K(76288K)] [ParOldGen: 10469K-&gt;9174K(114176K)] 14032K-&gt;9174K(190464K), [Metaspace: 25137K-&gt;25137K(1071104K)], 0.0724521 secs] [Times: user=0.38 sys=0.01, real=0.07 secs]
</code></pre><p>It is generally recommended to use the <code>-XX:+DisableExplicitGC</code> JVM option to disable forceful GC events. This will allow
the JVM to still have garbage collections, but it disables them from being triggered explicitly. The description of this option:</p>
<blockquote>
<p>By default calls to System.gc() are enabled (-XX:-DisableExplicitGC). Use -XX:+DisableExplicitGC to disable calls to System.gc(). Note that the JVM still performs garbage collection when necessary.</p>
</blockquote>
<h2 id="gathering-gc-logs">Gathering GC Logs</h2>
<h3 id="enabling-logs">Enabling logs</h3>
<p>With our service, let&rsquo;s go ahead and start it up with GC logging enabled:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># Navigate to the root directory of this project</span>
java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:gc.log -XX:GCLogFileSize<span style="color:#ce5c00;font-weight:bold">=</span>5M -XX:NumberOfGCLogFiles<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span> -jar java-perf-workshop-server/target/java-perf-workshop-server-1.1.0-SNAPSHOT.jar server server.yml 
</code></pre></div><h3 id="parsing-the-log">Parsing the log</h3>
<p>For parsing the logs, we are just going to show a simple approach using <a href="https://www.r-project.org/">R</a> to parse the
<code>gc.log</code> that we created. To do this, we will use the <code>stringr</code> package.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#8f5902;font-style:italic"># Including stringr package for regex</span>
<span style="color:#000">library</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stringr</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Navigating to where the project is at on my filesystem</span>
<span style="color:#000">setwd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;~/java-perf-workshop&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Read the GC log file in</span>
<span style="color:#000">gc</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">readLines</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;gc.log&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Regex the matches</span>
<span style="color:#000">matches</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">str_match</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(\\d+)K-&gt;(\\d+)K\\((\\d+)K\\),\\s(\\d+.\\d+)\\ssecs.*\\[Times\\: user=(\\d+.\\d+) sys=(\\d+.\\d+), real=(\\d+.\\d+) secs&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Look at what matches, now we want to filter out the NA</span>
<span style="color:#000">matches</span>

<span style="color:#8f5902;font-style:italic"># Filter content out and convert to a data frame</span>
<span style="color:#000">gc.df</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data.frame</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">na.omit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">matches[</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">stringsAsFactors</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># Add a column header to describe fields</span>
<span style="color:#000">colnames</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gc.df</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HeapUsedBeforeGC_KB&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;HeapUsedAfterGC_KB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;HeapCapacity_KB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;GCPauseTime_Sec&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;GCUserTime_Sec&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;GCSysTime_Sec&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;GCRealTime_Sec&#34;</span><span style="color:#000;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># List out the contents of the data frame</span>
<span style="color:#000">gc.df</span>
</code></pre></div><p>Example output:</p>
<pre><code>  HeapUsedBeforeGC_KB HeapUsedAfterGC_KB HeapCapacity_KB GCPauseTime_Sec GCUserTime_Sec GCSysTime_Sec GCRealTime_Sec
1               65536              12554          251392       0.0091645           0.03          0.01           0.01
2               45883              12707          316928       0.0092271           0.03          0.01           0.01
</code></pre><p>Reminder on the types of time being collected:</p>
<ul>
<li><code>GCUserTime_Sec</code>: User space time</li>
<li><code>GCSysTime_Sec</code>: Kernel space time (operating system)</li>
<li><code>GCRealTime_Sec</code>: Complete time taken</li>
</ul>
<p>Notice that the <code>GCRealTime_Sec</code> should closely align with the <code>GCPauseTime_Sec</code> value (just rounded up). If you notice that the
<code>GCUserTime_Sec</code> is much larger than the <code>GCRealTime_Sec</code>, you can conclude that multiple threads are executing garbage collection,
as <code>GCUserTime_Sec</code> is just the sum time of all the threads.</p>
<h2 id="external-tools">External Tools</h2>
<h3 id="gc-easy">GC Easy</h3>
<p>There&rsquo;s an existing tool <a href="http://gceasy.io/">GC Easy</a> which will do GC log parsing and analysis as well.</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/cchesser/java-perf-workshop">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 - All Rights Reserved</small>
        
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>













<script src="/js/main.min.f820bfc507c3ebefe17f8881ec4ee10013f3b89ad9555a50acf9bb1771e6823f.js" integrity="sha256-&#43;CC/xQfD6&#43;/hf4iB7E7hABPzuJrZVVpQrPm7F3Hmgj8=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
