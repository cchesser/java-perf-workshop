<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://jvmperf.net/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://jvmperf.net/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Workshop | jvmperf: JVM Performance Workshop</title>
<meta name="description" content="JVM performance workshop that leverages open-source tooling to discover how your JVM is performing">
<meta property="og:url" content="https://jvmperf.net/docs/">
  <meta property="og:site_name" content="jvmperf: JVM Performance Workshop">
  <meta property="og:title" content="Workshop">
  <meta property="og:description" content="JVM performance workshop that leverages open-source tooling to discover how your JVM is performing">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="Workshop">
  <meta itemprop="description" content="JVM performance workshop that leverages open-source tooling to discover how your JVM is performing">
  <meta itemprop="dateModified" content="2022-11-03T23:43:36-05:00">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Workshop">
  <meta name="twitter:description" content="JVM performance workshop that leverages open-source tooling to discover how your JVM is performing">
<link rel="preload" href="/scss/main.min.b1a08ef06828af656c445fc3845aaa52cc36563fcda9899b8d606c2c6b27b6e5.css" as="style" integrity="sha256-saCO8Ggor2VsRF/DhFqqUsw2Vj/NqYmbjWBsLGsntuU=" crossorigin="anonymous">
<link href="/scss/main.min.b1a08ef06828af656c445fc3845aaa52cc36563fcda9899b8d606c2c6b27b6e5.css" rel="stylesheet" integrity="sha256-saCO8Ggor2VsRF/DhFqqUsw2Vj/NqYmbjWBsLGsntuU=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 640 640" stroke-miterlimit="10" style="fill-rule:nonzero;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs/><g id="Layer-1" visibility="hidden"><path d="M568434e-19 568434e-19H640V640h-640v-640z" fill="#000002" fill-rule="nonzero" opacity="1" stroke="none"/></g><g id="Untitled"><g opacity="1"><g opacity="1"><path d="M561.328 180.1C544.048 169.8 524.148 168.18 500.308 172.64 484.928 175.52 468.208 181.44 450.288 190.46 450.548 184.2 450.688 178 450.688 171.9H450.488C451.028 169.1 451.308 166.26 451.308 163.4c0-48.42-79.16-87.66-176.8-87.66-97.64.0-176.8002 39.26-176.8002 87.66C97.7078 166.26 97.9878 169.1 98.5278 171.9H98.4278C97.7478 273.7 118.708 375.7 117.088 477.4 116.308 525.78 176.468 564.26 274.048 564.26c97.58.0 146-39.4 146-86.86C420.048 470.94 420.168 464.48 420.388 457.98 471.608 460.74 514.528 437.34 544.628 404.48 575.908 370.36 595.068 326.32 599.988 285.02 604.908 243.72 595.808 200.68 561.268 180.08L561.328 180.1zm-286.14-54.94c74.5.0 134.88 20.44 134.88 45.64C410.068 171.16 410.048 171.54 410.028 171.9 410.008 172.28 409.968 172.66 409.908 173.04 409.848 173.4 409.788 173.74 409.708 174.1 409.708 174.14 409.688 174.16 409.688 174.2 409.608 174.54 409.528 174.86 409.428 175.18 409.408 175.24 409.408 175.28 409.388 175.34 409.288 175.66 409.188 175.96 409.088 176.28 409.068 176.34 409.048 176.42 409.028 176.48 408.908 176.78 408.788 177.08 408.668 177.38 408.628 177.46 408.608 177.54 408.568 177.62 408.448 177.9 408.308 178.2 408.148 178.48 408.108 178.56 408.068 178.66 408.028 178.74 407.888 179.02 407.728 179.3 407.568 179.56 407.508 179.66 407.468 179.74 407.408 179.84 407.248 180.1 407.068 180.38 406.908 180.64 406.848 180.74 406.788 180.84 406.708 180.94 406.528 181.2 406.348 181.46 406.148 181.72 406.068 181.82 406.008 181.92 405.928 182.04 405.728 182.3 405.528 182.54 405.328 182.8 405.248 182.9 405.168 183.02 405.068 183.12 404.868 183.36 404.648 183.62 404.428 183.86 404.328 183.96 404.248 184.08 404.148 184.18 403.928 184.42 403.688 184.66 403.468 184.9 403.368 185.02 403.248 185.12 403.148 185.24 402.908 185.48 402.668 185.72 402.428 185.94 402.308 186.06 402.188 186.16 402.068 186.28 401.828 186.52 401.568 186.74 401.308 186.96 401.168 187.08 401.048 187.2 400.908 187.3 400.648 187.52 400.388 187.76 400.108 187.98 399.968 188.1 399.828 188.22 399.688 188.34 399.408 188.56 399.128 188.78 398.848 189 398.688 189.12 398.548 189.24 398.388 189.36 398.108 189.58 397.808 189.8 397.508 190 397.348 190.12 397.188 190.24 397.028 190.36 396.728 190.58 396.428 190.78 396.128 190.98 395.948 191.1 395.788 191.22 395.608 191.34 395.308 191.54 394.988 191.74 394.668 191.96 394.488 192.08 394.288 192.2 394.108 192.32 393.788 192.52 393.468 192.72 393.148 192.92 392.948 193.04 392.748 193.16 392.548 193.28 392.228 193.48 391.888 193.68 391.548 193.86 391.348 193.98 391.128 194.1 390.928 194.22 390.588 194.42 390.248 194.6 389.888 194.8 389.668 194.92 389.448 195.04 389.228 195.16 388.888 195.34 388.528 195.54 388.168 195.72 387.928 195.84 387.708 195.96 387.468 196.08 387.108 196.26 386.748 196.44 386.368 196.62 386.128 196.74 385.888 196.86 385.648 196.98 385.268 197.16 384.908 197.34 384.528 197.52 384.268 197.64 384.028 197.76 383.768 197.88 383.388 198.06 383.008 198.22 382.608 198.4 382.348 198.52 382.088 198.64 381.808 198.74 381.428 198.9 381.028 199.08 380.628 199.24 380.348 199.36 380.068 199.48 379.808 199.58 379.408 199.74 379.008 199.9 378.608 200.08 378.328 200.2 378.028 200.3 377.748 200.42 377.348 200.58 376.928 200.74 376.508 200.9 376.208 201.02 375.928 201.12 375.628 201.24 375.208 201.4 374.788 201.56 374.368 201.7 374.068 201.82 373.748 201.92 373.448 202.04 373.028 202.2 372.608 202.34 372.168 202.5 371.848 202.62 371.528 202.72 371.208 202.84 370.788 202.98 370.348 203.14 369.908 203.28 369.588 203.38 369.248 203.5 368.928 203.6 368.488 203.74 368.048 203.88 367.608 204.02 367.268 204.12 366.928 204.24 366.588 204.34 366.148 204.48 365.708 204.62 365.248 204.76 364.888 204.86 364.548 204.98 364.188 205.08 363.748 205.22 363.288 205.34 362.828 205.48 362.468 205.58 362.108 205.68 361.748 205.78 361.288 205.9 360.828 206.04 360.368 206.16 359.988 206.26 359.628 206.36 359.248 206.46 358.788 206.58 358.328 206.7 357.868 206.82 357.488 206.92 357.108 207.02 356.708 207.12 356.248 207.24 355.768 207.36 355.288 207.48 354.908 207.58 354.508 207.68 354.108 207.76 353.628 207.88 353.148 208 352.668 208.1 352.268 208.2 351.868 208.28 351.468 208.38 350.988 208.5 350.508 208.6 350.028 208.72 349.628 208.82 349.208 208.9 348.788 209 348.308 209.1 347.828 209.22 347.328 209.32 346.908 209.42 346.488 209.5 346.068 209.58 345.568 209.68 345.088 209.78 344.588 209.88 344.168 209.96 343.728 210.06 343.308 210.14 342.808 210.24 342.308 210.34 341.808 210.44 341.368 210.52 340.928 210.6 340.508 210.68 340.008 210.78 339.508 210.86 338.988 210.96 338.548 211.04 338.088 211.12 337.648 211.2 337.148 211.3 336.628 211.38 336.128 211.46 335.668 211.54 335.208 211.62 334.748 211.7 334.248 211.78 333.728 211.86 333.208 211.96 332.748 212.04 332.268 212.1 331.808 212.18 331.288 212.26 330.768 212.34 330.248 212.42 329.768 212.5 329.308 212.56 328.828 212.64 328.308 212.72 327.788 212.8 327.268 212.86 326.788 212.92 326.288 213 325.808 213.06 325.288 213.14 324.768 213.2 324.248 213.28 323.748 213.34 323.248 213.4 322.748 213.48 322.228 213.54 321.708 213.62 321.168 213.68 320.668 213.74 320.168 213.8 319.668 213.86 319.148 213.92 318.608 213.98 318.088 214.04 317.588 214.1 317.068 214.16 316.568 214.2 316.028 214.26 315.508 214.32 314.968 214.38 314.448 214.44 313.928 214.48 313.428 214.54 312.888 214.6 312.348 214.64 311.808 214.7 311.288 214.74 310.768 214.8 310.248 214.84 309.708 214.88 309.168 214.94 308.608 214.98 308.048 215.02 307.528 215.06 306.988 215.12 306.448 215.16 305.928 215.2 305.388 215.26 304.848 215.32 304.268 215.34 303.708 215.38 303.188 215.42 302.668 215.46 302.128 215.5 301.568 215.54 300.988 215.58 300.428 215.62 299.908 215.66 299.368 215.68 298.848 215.72 298.268 215.76 297.688 215.78 297.088 215.82 296.568 215.84 296.048 215.88 295.528 215.9 294.928 215.94 294.328 215.96 293.728 215.98 293.208 216 292.708 216.02 292.188 216.06 291.588 216.08 290.968 216.1 290.368 216.14 289.848 216.16 289.348 216.18 288.828 216.2 288.208 216.22 287.588 216.24 286.968 216.26 286.448 216.28 285.948 216.3 285.428 216.3 284.788 216.32 284.148 216.32 283.488 216.34 282.988 216.36 282.508 216.36 282.008 216.38 281.248 216.4 280.508 216.4 279.748 216.4 279.348 216.4 278.968 216.42 278.568 216.42 277.448 216.42 276.308 216.44 275.188 216.44 275.168 216.44 275.148 216.44 275.128 216.44 273.968 216.44 272.828 216.44 271.668 216.42 271.328 216.42 270.988 216.42 270.648 216.4 269.848 216.4 269.028 216.38 268.228 216.36 267.788 216.36 267.348 216.34 266.908 216.34 266.208 216.32 265.508 216.32 264.828 216.3 264.368 216.28 263.908 216.28 263.428 216.26 262.768 216.24 262.088 216.22 261.428 216.2 260.968 216.18 260.508 216.16 260.048 216.14 259.388 216.12 258.728 216.1 258.068 216.06 257.608 216.04 257.148 216.02 256.688 216 256.028 215.96 255.388 215.94 254.728 215.9 254.268 215.88 253.808 215.84 253.328 215.82 252.688 215.78 252.048 215.76 251.408 215.72 250.928 215.7 250.468 215.66 249.988 215.62 249.368 215.58 248.748 215.54 248.128 215.5 247.648 215.46 247.188 215.44 246.708 215.4 246.088 215.36 245.468 215.32 244.868 215.26 244.388 215.22 243.908 215.18 243.428 215.14 242.828 215.1 242.248 215.04 241.648 215 241.148 214.96 240.668 214.92 240.188 214.86 239.608 214.8 239.028 214.76 238.448 214.7 237.968 214.66 237.488 214.6 237.008 214.56 236.428 214.5 235.868 214.44 235.288 214.38 234.808 214.34 234.328 214.28 233.848 214.22 233.288 214.16 232.708 214.1 232.148 214.04 231.668 213.98 231.208 213.92 230.728 213.88 230.168 213.82 229.608 213.74 229.048 213.68 228.588 213.62 228.108 213.56 227.648 213.5 227.088 213.42 226.528 213.36 225.988 213.28 225.528 213.22 225.068 213.16 224.608 213.1 224.068 213.02 223.508 212.96 222.968 212.88 222.508 212.82 222.048 212.74 221.588 212.68 221.048 212.6 220.528 212.52 219.988 212.44 219.528 212.36 219.068 212.3 218.608 212.22 218.088 212.14 217.548 212.06 217.028 211.98 216.568 211.9 216.128 211.84 215.668 211.76 215.148 211.68 214.628 211.58 214.108 211.5 213.648 211.42 213.208 211.34 212.768 211.26 212.248 211.16 211.748 211.08 211.248 210.98 210.808 210.9 210.348 210.82 209.908 210.74 209.408 210.64 208.908 210.56 208.428 210.46 207.988 210.38 207.548 210.28 207.108 210.2 206.608 210.1 206.128 210 205.648 209.9 205.208 209.82 204.788 209.72 204.348 209.64 203.868 209.54 203.368 209.44 202.908 209.34 202.488 209.24 202.048 209.16 201.628 209.06 201.148 208.96 200.688 208.86 200.208 208.74 199.788 208.64 199.368 208.54 198.928 208.44 198.468 208.34 198.008 208.22 197.548 208.12 197.128 208.02 196.708 207.92 196.288 207.82 195.828 207.7 195.388 207.6 194.928 207.48 194.508 207.38 194.108 207.28 193.708 207.16 193.268 207.04 192.808 206.92 192.368 206.82 191.968 206.72 191.568 206.6 191.168 206.5 190.728 206.38 190.288 206.26 189.868 206.14 189.468 206.02 189.068 205.92 188.668 205.8 188.248 205.68 187.828 205.56 187.408 205.44 187.008 205.32 186.628 205.22 186.228 205.1 185.808 204.98 185.388 204.86 184.988 204.72 184.608 204.6 184.228 204.48 183.828 204.36 183.428 204.24 183.028 204.1 182.628 203.98 182.228 203.86 181.868 203.74 181.488 203.62 181.088 203.5 180.708 203.36 180.308 203.24S179.568 202.98 179.188 202.86C178.808 202.72 178.428 202.6 178.048 202.46 177.668 202.32 177.328 202.2 176.948 202.08 176.568 201.94 176.208 201.82 175.848 201.68 175.488 201.54 175.128 201.42 174.768 201.28 174.408 201.14 174.048 201 173.708 200.88S173.008 200.6 172.648 200.46C172.288 200.32 171.948 200.18 171.608 200.04 171.268 199.9 170.928 199.76 170.588 199.62 170.248 199.48 169.908 199.34 169.588 199.2 169.268 199.06 168.908 198.92 168.588 198.78 168.268 198.64 167.948 198.5 167.608 198.36 167.268 198.22 166.948 198.06 166.628 197.92 166.308 197.78 166.008 197.64 165.688 197.48 165.368 197.32 165.048 197.18 164.728 197.02 164.428 196.88 164.128 196.72 163.828 196.58 163.528 196.44 163.208 196.28 162.908 196.12 162.608 195.98 162.328 195.82 162.028 195.68 161.728 195.54 161.428 195.38 161.148 195.22S160.588 194.92 160.308 194.76 159.728 194.44 159.448 194.28C159.188 194.12 158.908 193.98 158.648 193.82S158.088 193.5 157.808 193.34C157.548 193.18 157.288 193.04 157.048 192.88S156.508 192.56 156.248 192.38C156.008 192.22 155.768 192.06 155.508 191.92 155.248 191.78 154.988 191.58 154.728 191.42 154.488 191.26 154.268 191.1 154.028 190.94 153.768 190.76 153.528 190.6 153.288 190.42 153.068 190.26 152.848 190.1 152.648 189.94 152.408 189.76 152.168 189.58 151.928 189.42 151.728 189.26 151.508 189.1 151.308 188.94 151.088 188.76 150.848 188.58 150.628 188.4 150.428 188.24 150.248 188.08 150.048 187.92 149.828 187.74 149.608 187.56 149.408 187.38 149.228 187.22 149.048 187.06 148.868 186.9 148.668 186.72 148.448 186.54 148.268 186.34 148.088 186.18 147.928 186.02 147.768 185.86 147.568 185.68 147.388 185.48 147.188 185.3 147.028 185.14 146.868 184.98 146.728 184.82 146.548 184.62 146.368 184.44 146.188 184.24 146.048 184.08 145.908 183.92 145.768 183.76 145.608 183.56 145.428 183.38 145.268 183.18 145.128 183.02 145.008 182.86 144.868 182.7 144.708 182.5 144.548 182.3 144.408 182.1 144.288 181.94 144.168 181.76 144.048 181.6 143.908 181.4 143.768 181.2 143.628 181 143.508 180.84 143.408 180.66 143.308 180.5 143.188 180.3 143.048 180.1 142.928 179.9 142.828 179.74 142.748 179.58 142.648 179.4 142.528 179.2 142.408 178.98 142.308 178.78 142.228 178.62 142.148 178.46 142.068 178.28 141.968 178.06 141.868 177.86 141.768 177.64 141.688 177.48 141.628 177.32 141.568 177.16 141.488 176.94 141.388 176.74 141.308 176.52 141.248 176.36 141.208 176.2 141.148 176.04 141.068 175.82 141.008 175.6 140.928 175.4 140.888 175.24 140.848 175.08 140.808 174.92 140.748 174.7 140.688 174.48 140.648 174.26 140.608 174.1 140.588 173.94 140.568 173.78 140.528 173.56 140.468 173.32 140.448 173.1 140.428 172.94 140.408 172.8 140.388 172.64 140.368 172.4 140.328 172.16 140.308 171.94 140.288 171.56 140.268 171.18 140.268 170.82c0-25.2 60.38-45.62 134.88-45.62L275.188 125.16zm280.38 155.46C551.828 312 536.648 348.34 512.548 374.64c-23.16 25.28-52.42 40.8-89.2 38.76C428.708 355.82 439.408 298.2 445.728 244.54c51.92-33.18 80.86-33.46 93.52-25.9C552.068 226.28 559.288 249.26 555.548 280.64L555.568 280.62z" fill="#fff" fill-rule="nonzero" opacity="1" stroke="none"/></g></g></g><g id="Layer-2"><path d="M160.46 426.36l49.957-77.89 35.991 109.583 31.156-176.192L320 408.096l23.098-72.518 31.156 34.379" fill="none" opacity="1" stroke="#000002" stroke-linecap="butt" stroke-linejoin="round" stroke-width="17.1009"/></g></svg></span><span class="navbar-brand__name">jvmperf: JVM Performance Workshop</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/docs/"><i class="fas fa-tools"></i><span>Workshop</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/cchesser/java-perf-workshop/" target="_blank" rel="noopener"><i class="fa-brands fa-github"></i><span>GitHub</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/contributors/"><i class="fas fa-user-friends"></i><span>Contributors</span></a>
      </li>
      <li class="td-light-dark-menu nav-item dropdown">
        <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
  <symbol id="check2" viewBox="0 0 16 16">
    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
  </symbol>
  <symbol id="circle-half" viewBox="0 0 16 16">
    <path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
  </symbol>
  <symbol id="moon-stars-fill" viewBox="0 0 16 16">
    <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
    <path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/>
  </symbol>
  <symbol id="sun-fill" viewBox="0 0 16 16">
    <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
  </symbol>
</svg>

<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center"
        id="bd-theme"
        type="button"
        aria-expanded="false"
        data-bs-toggle="dropdown"
        data-bs-display="static"
        aria-label="Toggle theme (auto)">
  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg>
</button>
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#sun-fill"></use></svg>
      Light
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
      <svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"></use></svg>
      Dark
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
  <li>
    <button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
      <svg class="bi me-2 opacity-50"><use href="#circle-half"></use></svg>
      Auto
      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg>
    </button>
  </li>
</ul>

      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="Search this site…"
    aria-label="Search this site…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/offline-search-index.734b219fb2005f00374eb8314895945b.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Workshop</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-f3351e063429a5c5cbfec483b1ba8747">Prerequisites</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-66b565805ca1061be35ff2c0165f13c1">Setup</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-a5f739a8bec034e3bccefb4740e1c6ec">Process and Threads</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-9a22b492f19ba508a502052a88896ceb">JDK Mission Control &amp; Flight Recorder</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-8ee8dad6286e52b2b45f392d986ba479">Introduction</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-a19b61c681cd81aa3a52b7ab7f00e40a">Method Profiling</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-8e7ed7a50881f742b2d8880c7a90c384">Exceptions</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-140f7f618c6427a75628497db237e231">Threads</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-7fa58ef1806796b7bc181181489c25b1">Memory</a></li>


    
  
    
    
	
<li>4.6: <a href="#pg-677c02967c93d2d024e0683d7ffa6d55">I/O Operations</a></li>


    
  
    
    
	
<li>4.7: <a href="#pg-e82c7a3c3eba03724a0e8df5a3ff19a3">References</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-6ef11477fa79b0d64946ef4b156240fc">Memory Analysis</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-b09263a61c61dd500a73a2e9c3ccb14a">Memory Heap Analysis</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-035a04a1e49235510f91d61520c4915c">Capturing Heap Dumps</a></li>


    
  
    
    
	
<li>5.3: <a href="#pg-1f3119da9a3dcd2385759ec01a852380">JOverflow</a></li>


    
  
    
    
	
<li>5.4: <a href="#pg-c01af137813ea12c96aaecbb0580e4ae">Eclipse MAT</a></li>


    
  
    
    
	
<li>5.5: <a href="#pg-de268a519541f36805c09c8812e06816">VisualVM</a></li>


    
  
    
    
	
<li>5.6: <a href="#pg-605fd19420eabae15eb4ac1d0e6b77d1">Memory Challenge</a></li>


    
  
    
    
	
<li>5.7: <a href="#pg-c6512c461f5f3bf1ba4ced486f736874">Garbage Collections</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-7f540327752f6f763d88c618950bc207">Containers</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-748dbfb27e056e8f559709df6cea6e94">Setup</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-634bf2ba5287d43935922a4fc1edab6a">Java Monitoring Tooling</a></li>


    
  
    
    
	
<li>6.3: <a href="#pg-c470bf618fcbdd51c44b1b1135f55896">Docker Tooling</a></li>


    
  
    
    
	
<li>6.4: <a href="#pg-6362126ba5f5128b262a9fb88d5015e8">References</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-f3351e063429a5c5cbfec483b1ba8747">1 - Prerequisites</h1>
    <div class="lead">Instructions for acquiring the software needed for the workshop.</div>
	<h2 id="java-development-kit">Java Development Kit</h2>
<p>Install a Java Development Kit (17+) from Oracle or OpenJDK</p>
<ul>
<li><a href="https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html">Oracle</a></li>
<li><a href="https://openjdk.java.net/install/">OpenJDK</a></li>
</ul>
<h2 id="maven">Maven</h2>
<p>Install the latest available <a href="https://maven.apache.org/">Maven</a>.</p>
<h2 id="jdk-mission-control">JDK Mission Control</h2>
<p>Install JDK Mission Control from <a href="https://www.oracle.com/java/technologies/javase/products-jmc9-downloads.html">Oracle Mirror</a>.</p>
<h2 id="visualvm">VisualVM</h2>
<p>Install the standalone version of <a href="https://visualvm.github.io/">VisualVM</a>.</p>
<h2 id="eclipse-mat">Eclipse MAT</h2>
<p>Install the standalone version of <a href="https://www.eclipse.org/mat/">Eclipse MAT</a>.</p>
<h2 id="rancher-desktop--docker-cli">Rancher Desktop + Docker CLI</h2>
<p>Install the <a href="https://rancherdesktop.io/">Rancher Desktop</a> container runtime environment with the Docker CLI.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-66b565805ca1061be35ff2c0165f13c1">2 - Setup</h1>
    <div class="lead">Instructions for setting up the workshop</div>
	<p>In this section we&rsquo;re going to spin up the services needed for the workshop.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    Make sure you&rsquo;ve gone through the <a href="/docs/prereqs/">Prerequisites</a>

</div>

<h3 id="service">Service</h3>
<p>The web service is a <a href="http://www.dropwizard.io/">simple dropwizard server</a>, which has a single API to search for talks
from <a href="http://www.kcdc.info/">kcdc.info</a>, and returns results about these talks.</p>
<p><img src="/diagrams/workshop_service_interaction.png" alt=""></p>
<h4 id="running">Running</h4>
<p><strong>Prerequisites:</strong></p>
<ul>
<li>Maven</li>
<li>Java JDK</li>
</ul>
<p>Assemble the service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mvn clean package
</span></span></code></pre></div><p>💡 If you have issues with building it locally due to your setup, you can download the
server assembly <a href="https://github.com/cchesser/java-perf-workshop/wiki/java-perf-workshop-server-1.0-SNAPSHOT.jar">here</a>.</p>
<p>Start the workshop service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">java -jar java-perf-workshop-server/target/java-perf-workshop-server-1.1.0-SNAPSHOT.jar server server.yml
</span></span></code></pre></div><h4 id="mocking-service-dependency">Mocking Service Dependency</h4>
<p>To simulate responses of kcdc.info (as the service may change over time), we will first run a mock
instance of this service using <a href="http://wiremock.org/">WireMock</a>.</p>
<p><img src="/diagrams/interaction_wiremock.png" alt=""></p>
<p>Go ahead and start another terminal session where we will run another service to mock a remote dependency of the workshop service. Navigate
to the same directory where you cloned this repository, then execute the following commands:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mvn dependency:copy -Dartifact<span class="o">=</span>com.github.tomakehurst:wiremock-standalone:2.27.2 -Dmdep.stripVersion<span class="o">=</span><span class="nb">true</span> -DoutputDirectory<span class="o">=</span>.
</span></span></code></pre></div><p>Run the mock service, which will provide the essential end-points to support the service we will be
testing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">java -jar wiremock-standalone.jar --port <span class="m">9090</span> --root-dir java-perf-workshop-server/src/test/resources
</span></span></code></pre></div><p>Alternatively, you can run the <code>mockservice.sh</code> script which will do both commands, ie: <code>sh mockservice.sh</code></p>
<h4 id="configuration">Configuration</h4>
<p>Example configuration of service:</p>
<pre tabindex="0"><code>server:
  applicationConnectors:
    - type: http
      port: 80
  adminConnectors:
    - type: http
      port: 8071
  requestLog:
    timeZone: UTC
    appenders:
      - type: file
        currentLogFilename: /var/log/java-perf-workshop-server-access.log
        threshold: ALL
        archive: true
        archivedLogFilenamePattern: /var/log/java-perf-workshop-server-access.%d.log.gz
        archivedFileCount: 5
logging:
  level: INFO
  appenders:
    - type: file
      currentLogFilename: /var/log/java-perf-workshop-server.log
      threshold: ALL
      archive: true
      archivedLogFilenamePattern: /var/log/java-perf-workshop-server-%d.log
      archivedFileCount: 5
      timeZone: UTC
</code></pre><h4 id="testing">Testing</h4>
<p>The service will return back results from the KCDC website on sessions that are available which contain
a substring in their title, abstract, or tags. Example:</p>
<p><a href="http://localhost:8080/search?q=clojure">http://localhost:8080/search?q=clojure</a></p>
<p>Example results:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;results&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;title&#34;</span> <span class="p">:</span> <span class="s2">&#34;Concurrency Options on the JVM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;presenter&#34;</span> <span class="p">:</span> <span class="s2">&#34;Jessica Kerr&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;title&#34;</span> <span class="p">:</span> <span class="s2">&#34;Fast, Parallel, or Reliable: Pick 3, a tour of Elixir&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;presenter&#34;</span> <span class="p">:</span> <span class="s2">&#34;Jordan Day&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="troubleshooting">Troubleshooting</h4>
<p>If you get a <code>500</code> error message when trying to test the service, verify that the wiremock server is running.</p>
<pre tabindex="0"><code>{
  &#34;code&#34; : 500,
  &#34;message&#34; : &#34;There was an error processing your request. It has been logged (ID d8998189f8d4ee8c).&#34;
}
</code></pre><h3 id="reference">Reference</h3>
<ul>
<li><a href="https://github.com/cchesser/java-perf-workshop/wiki/slides/kcdc2015_whats_in_you_jvm.zip">KCDC 2015 workshop slides</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a5f739a8bec034e3bccefb4740e1c6ec">3 - Process and Threads</h1>
    <div class="lead">Initial look at the JVM from its native perspective.</div>
	<p>This first part of the workshop, we will begin to learn about looking at the JVM from its native perspective, and begin obtaining JVM based information to correlate to it&rsquo;s native representation.</p>
<h2 id="top">top</h2>
<p>A very common utility as to monitor processes in Linux. For our case, we will want to monitor our JVM process. When just executing <code>top</code>, you will see all processes on the host:</p>
<pre tabindex="0"><code>top - 05:32:51 up 8 min,  1 user,  load average: 0.05, 0.12, 0.06
Tasks:  62 total,   1 running,  61 sleeping,   0 stopped,   0 zombie
Cpu(s): 11.2%us,  0.7%sy,  0.0%ni, 87.8%id,  0.0%wa,  0.0%hi,  0.0%si,  0.3%st
Mem:   1020184k total,   466284k used,   553900k free,    17740k buffers
Swap:        0k total,        0k used,        0k free,   289500k cached

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 6730 ec2-user  20   0 2246m 108m  13m S 10.3 10.9   0:14.11 java
    1 root      20   0 19596 1616 1292 S  0.0  0.2   0:00.56 init
    2 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kthreadd
    3 root      20   0     0    0    0 S  0.0  0.0   0:00.02 ksoftirqd/0
    4 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kworker/0:0
    5 root       0 -20     0    0    0 S  0.0  0.0   0:00.00 kworker/0:0H
    6 root      20   0     0    0    0 S  0.0  0.0   0:00.04 kworker/u30:0
    7 root      20   0     0    0    0 S  0.0  0.0   0:00.27 rcu_sched
    8 root      20   0     0    0    0 S  0.0  0.0   0:00.00 rcu_bh
    9 root      RT   0     0    0    0 S  0.0  0.0   0:00.00 migration/0
</code></pre><p>You can switch in this view to also view the native threads, by hitting <code>Shift+H</code>.</p>
<pre tabindex="0"><code>top - 05:34:15 up 9 min,  1 user,  load average: 0.01, 0.09, 0.05
Tasks: 101 total,   1 running, 100 sleeping,   0 stopped,   0 zombie
Cpu(s):  4.0%us,  0.3%sy,  0.0%ni, 95.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Mem:   1020184k total,   491176k used,   529008k free,    17804k buffers
Swap:        0k total,        0k used,        0k free,   312648k cached
 Show threads On
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 6736 ec2-user  20   0 2246m 109m  13m S  2.0 11.0   0:05.72 java
 6737 ec2-user  20   0 2246m 109m  13m S  0.3 11.0   0:01.69 java
 6740 ec2-user  20   0 2246m 109m  13m S  0.3 11.0   0:01.67 java
 6746 ec2-user  20   0 2246m 109m  13m S  0.3 11.0   0:00.31 java
 6768 ec2-user  20   0 2246m 109m  13m S  0.3 11.0   0:00.03 java
 6778 ec2-user  20   0 2246m 109m  13m S  0.3 11.0   0:00.08 java
 6777 ec2-user  20   0 15224 1332 1032 R  0.3  0.1   0:00.04 top
    1 root      20   0 19596 1616 1292 S  0.0  0.2   0:00.56 init
    2 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kthreadd
    3 root      20   0     0    0    0 S  0.0  0.0   0:00.02 ksoftirqd/0
    4 root      20   0     0    0    0 S  0.0  0.0   0:00.00 kworker/0:0
</code></pre><p>With these native threads, you can now get better context of what resources are being utilized. To simplify this, you can target top to just watch one parent process and then show threads via:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">top -H -p &lt;PID&gt;
</span></span></code></pre></div><p>In our earlier example, our PID was 6730. Therefore, this would produce:</p>
<pre tabindex="0"><code>$ top -H -p 6730
top - 05:38:05 up 13 min,  1 user,  load average: 0.00, 0.05, 0.05
Tasks:  32 total,   0 running,  32 sleeping,   0 stopped,   0 zombie
Cpu(s):  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Mem:   1020184k total,   515940k used,   504244k free,    17932k buffers
Swap:        0k total,        0k used,        0k free,   336520k cached

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 6739 ec2-user  20   0 2246m 110m  13m S  0.3 11.1   0:00.24 java
 6730 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:00.00 java
 6731 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:01.50 java
 6732 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:01.07 java
 6733 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:00.00 java
 6734 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:00.00 java
 6735 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:00.00 java
 6736 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:07.33 java
 6737 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:01.69 java
 6738 ec2-user  20   0 2246m 110m  13m S  0.0 11.1   0:00.00 java
</code></pre><p>To make a simple standard capture of native threads for diagnostic purposes, you can do the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">top -b -n3 -H -p &lt;PID&gt;
</span></span></code></pre></div><p>This will capture thread iterations of <code>top</code> by capturing threads of the parent process ID. You can then pipe it to a file.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">top -b -n3 -H -p <span class="m">6730</span> &gt; jvm_native_threads.log
</span></span></code></pre></div><h2 id="java-utilities">Java Utilities</h2>
<p>There&rsquo;s a couple of java utilities that can also be used to find the PIDs of your running processes.</p>
<h3 id="jps">jps</h3>
<p>The <a href="https://docs.oracle.com/javase/7/docs/technotes/tools/share/jps.html">Java Virtual Machine Process Status Tool</a> can be used to see Java processes.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> $ jps
</span></span><span class="line"><span class="cl"><span class="m">7241</span> Jps
</span></span><span class="line"><span class="cl"><span class="m">6059</span> java-perf-workshop-server-1.1.0-SNAPSHOT.jar
</span></span><span class="line"><span class="cl"><span class="m">6925</span> jar
</span></span></code></pre></div><p>You can get more insight by using some of its flags:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> $ jps -lvm
</span></span><span class="line"><span class="cl"><span class="m">6059</span> java-perf-workshop-server/target/java-perf-workshop-server-1.1.0-SNAPSHOT.jar server server.yml
</span></span><span class="line"><span class="cl"><span class="m">6925</span> wiremock-standalone.jar --port <span class="m">9090</span> --root-dir java-perf-workshop-server/src/test/resources
</span></span><span class="line"><span class="cl"><span class="m">7582</span> sun.tools.jps.Jps -lvm -Dapplication.home<span class="o">=</span>/Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home -Xms8m
</span></span></code></pre></div><h3 id="jcmd">jcmd</h3>
<p>The <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/tooldescr006.html">jcmd</a> utility is an attempt to consolidate other utilities into a single interface.</p>
<p>Running the <code>jcmd</code> command should display some of the same information that <code>jps</code> showed us (similar to <code>jps -m</code>):</p>
<pre tabindex="0"><code>$ jcmd
6059 java-perf-workshop-server/target/java-perf-workshop-server-1.1.0-SNAPSHOT.jar server server.yml
6925 wiremock-standalone.jar --port 9090 --root-dir java-perf-workshop-server/src/test/resources
7838 sun.tools.jcmd.JCmd
</code></pre><h2 id="thread-dump">Thread Dump</h2>
<p>To capture a thread dump of the JVM, there are many tools that can achieve this. You can do this over JMX remotely, sending an OS signal (<code>kill -3</code>), or just form the command line (<code>jstack</code> or <code>jcmd</code>). To keep it simple, we will just use <code>jcmd</code> as we will use it later for other diagnostic commands.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">jcmd &lt;PID&gt; Thread.print
</span></span></code></pre></div><p>💡 You need to be the same OS user when invoking the command as the target JVM.</p>
<p>So, using our earlier example, this would be:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">jcmd <span class="m">6730</span> Thread.print
</span></span></code></pre></div><p>However, correlating a thread dump to the native thread state requires a minor translation. In your thread dump, the native thread identifier is in hexadecimal, while the native thread identifiers from <code>top</code> are in decimal. Therefore, if you notice a thread spiking in the <code>top</code> view, you would then want to understand what cod it is correlating to. You can do this simply from the command line via:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">printf</span> <span class="s2">&#34;%x\n&#34;</span> &lt;Decimal Thread ID&gt;
</span></span></code></pre></div><p>Example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">printf</span> <span class="s2">&#34;%x\n&#34;</span> <span class="m">6736</span>
</span></span><span class="line"><span class="cl">1a50
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></div><p>I can then cross reference this thread to my thread dump via the <code>nid</code> (native thread ID) field:</p>
<pre tabindex="0"><code>&#34;C2 CompilerThread0&#34; #5 daemon prio=9 os_prio=0 tid=0x00007efda40d4000 nid=0x1a50 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE
</code></pre><p>An alternative tool <a href="https://fastthread.io/"><code>fastthread.io</code></a> also has a blog on other ways to capture a <a href="https://blog.fastthread.io/2016/06/06/how-to-take-thread-dumps-7-options/">thread dump</a></p>
<h2 id="jcmd-perfcounter">jcmd PerfCounter</h2>
<p>A very simple and quick collection of stats on a JVM can be collected via:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">jcmd &lt;PID&gt; PerfCounter.print
</span></span></code></pre></div><p>Generally the information in this file may or may not indicate the actual problem, but can provide more context in a concise text file of what all has occurred in the life of that JVM. One simple set of counters related to threads are:</p>
<pre tabindex="0"><code>java.threads.daemon=20
java.threads.live=26
java.threads.livePeak=38
java.threads.started=697
</code></pre><h2 id="strace">strace</h2>
<p>In some rare cases, you may need to figure out what system calls your JVM is doing. One way to do this on several flavors of Linux, is to use <code>strace</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">strace -f -v -p &lt;PID&gt;
</span></span></code></pre></div><p>Example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">strace -f -v -p <span class="m">6730</span>
</span></span></code></pre></div><p>Example output:</p>
<pre tabindex="0"><code>[pid  6741] futex(0x7efda4587228, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished ...&gt;
[pid  6740] write(1, &#34;DEBUG [2015-06-24 05:50:34,727] &#34;..., 168 &lt;unfinished ...&gt;
[pid  6830] gettimeofday( &lt;unfinished ...&gt;
</code></pre><p>From the <code>write</code> call, we can see it is tied to the thread ID 6740. If we translate it to <code>x1a54</code>, which is then tied to this logging thread in the JVM.</p>
<pre tabindex="0"><code>&#34;AsyncAppender-Worker-Thread-1&#34; #9 daemon prio=5 os_prio=0 tid=0x00007efda44d1800 nid=0x1a54 waiting on condition [0x00007efd941f0000]
   java.lang.Thread.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait for  &lt;0x00000000f5d38d20&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
</code></pre><p>You will notice that the system calls are quite noisy with the JVM, but this type of troubleshooting can greatly help when the JVM is getting &ldquo;hung&rdquo; or hitting limits by the OS and it isn&rsquo;t clear from the exception that you are seeing what it is getting restricted on.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9a22b492f19ba508a502052a88896ceb">4 - JDK Mission Control &amp; Flight Recorder</h1>
    <div class="lead">Initial look at the JVM from its native perspective.</div>
	<p>In this workshop, we will be getting more familiar with using JDK Mission Control and the Flight Recorder. As we have been running our service, we want to gather more insight of the code in the service by running series of simple tests and measuring the service.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8ee8dad6286e52b2b45f392d986ba479">4.1 - Introduction</h1>
    <div class="lead">Introduction into JDK Mission Control with Flight Recorder</div>
	<h2 id="jdk-flight-recorder">JDK Flight Recorder</h2>
<p>The JDK Flight Recorder (JFR) is a very low overhead profiling and diagnostics tool. It was inherited from the JRockit JVM, and originally was offered as part of the HotSpot JVM. It is designed to be &ldquo;black box&rdquo; data recorder of the the run-time, which can be used in production environments, making it an attractive tool for profiling code since it has low overhead on the JVM. In 2018, it was open-sourced and released as part of OpenJDK.</p>
<p>JFR is enabled by default in Java 11 and later. In previous versions, it required enabling with JVM options (ex. <code>-XX:+FlightRecorder</code>)</p>
<h3 id="higher-fidelity-on-method-profiling">Higher Fidelity on Method Profiling</h3>
<p>To get better fidelity on method profiling, include the following options which will enable the compiler to include additional metadata on non-safe code points. This is helpful, as sometimes the metadata will not fully resolve to the correct line in the code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">-XX:+UnlockDiagnosticVMOptions -XX:+DebugNonSafepoints
</span></span></code></pre></div><h2 id="jdk-mission-control">JDK Mission Control</h2>
<p>We will be using JDK Mission Control to monitor and evaluate the Java flight recordings. To utilizes JDK Mission Control, you will need to <a href="https://jdk.java.net/jmc/9/">download the build</a>. To start up JDK Mission Control, simply executing the following in your console:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">jmc
</span></span></code></pre></div><p>💡 In order to be able to invoke <code>jmc</code> (JDK Mission Control) from your console, it assumes <code>$JAVA_HOME/bin</code> is on your <code>$PATH</code>. If it is not included, go ahead and update your profile to include this so you can easily invoke <code>jmc</code> from your terminal. Also, JMC 9.1 <a href="https://www.oracle.com/java/technologies/javase/jmc9-install.html">requires JDK 21</a>.</p>
<h2 id="start-service-with-jfr">Start Service with JFR</h2>
<p>Let&rsquo;s start profiling our service. Start the service up by enabling JFR:</p>
<h3 id="start-from-the-console">Start from the console</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Note, if you are running this server from a different folder, consider changing the SERVER_HOME</span>
</span></span><span class="line"><span class="cl"><span class="nv">SERVER_HOME</span><span class="o">=</span>java-perf-workshop-server/target
</span></span><span class="line"><span class="cl">java -XX:+UnlockDiagnosticVMOptions -XX:+DebugNonSafepoints -jar <span class="nv">$SERVER_HOME</span>/java-perf-workshop-server-1.1.0-SNAPSHOT.jar server server.yml
</span></span></code></pre></div><h2 id="start-flight-recording-from-jmc">Start Flight Recording from JMC</h2>
<p><img src="/jmc/start_flight_recording.png" alt="jmc_start"></p>
<p>This will open a window where you apply some settings for the recording. First select that you want this to be a <strong>Continuous recording</strong> and for Event settings, we will import a template to get some consistent settings for profiling. Within the <strong>Template Manager</strong>, select <strong>Import Files&hellip;</strong> and import the <code>open_jdk_9_.jfc</code> included in the <a href="https://github.com/cchesser/java-perf-workshop/tree/main/docs/content/docs/jmc">content/docs/jmc</a> folder. It should appear as <em>Java Performance Workshop JDK9+ Profile</em>. Select this as the <strong>Event Settings</strong> and then click on <strong>Finish</strong>.</p>
<p>For reference, these are the options for the template.</p>
<p><img src="img/jfr-settings.png.png" alt=""></p>
<p>First select that you want this to be a <strong>Continuous recording</strong> and for Event settings we will use <strong>Profiling on Server</strong>.</p>
<p><img src="img/jfr-start-wizard.png.png" alt=""></p>
<p>Once your flight recording is being captured in a <em>Continuous</em> recording, it will show a ∞.</p>
<p><img src="img/jfr-started.png" alt="jmc_started"></p>
<p>💡 You can see the JFR templates (continuous / profile) which are shipped as part of the JRE in: <code>$JAVA_HOME/jre/lib/jfr</code>. These become helpful if you are wanting to compare your settings to some of the standard ones.</p>
<h2 id="generate-http-traffic-on-service">Generate HTTP traffic on service</h2>
<p>We will want to generate some traffic on the service to measure some general characteristics of the service:</p>
<ul>
<li>Throughput (requests per second)</li>
<li>Response time</li>
<li>Trend of response time over time</li>
</ul>
<p><img src="/diagrams/web_traffic.png" alt=""></p>
<p>By generating traffic on service, this gives us baseline activity in the JVM to start evaluating the flight recording.</p>
<h3 id="basic-test">Basic test</h3>
<p>This service under test, is a simple web service which provides results based on a search API. When interacting with the service, you can simply supply a HTTP GET on the <em>search</em> resource with a query parameter (&lsquo;q&rsquo;) with the term that you are searching for. It will then return KCDC&rsquo;s 2015 sessions that contain that term. Example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl <span class="s2">&#34;http://localhost:8080/search?q=jvm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;results&#34;</span> : <span class="o">[</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;title&#34;</span> : <span class="s2">&#34;Concurrency Options on the JVM&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;presenter&#34;</span> : <span class="s2">&#34;Jessica Kerr&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;sessionType&#34;</span> : <span class="s2">&#34;Regular Session&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;title&#34;</span> : <span class="s2">&#34;Exploring the Actor Model with Akka.NET&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;presenter&#34;</span> : <span class="s2">&#34;Robert Macdonald Smith&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;sessionType&#34;</span> : <span class="s2">&#34;Regular Session&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;title&#34;</span> : <span class="s2">&#34;What&#39;s in your JVM?&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;presenter&#34;</span> : <span class="s2">&#34;Carl Chesser&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;sessionType&#34;</span> : <span class="s2">&#34;4-Hour Workshop&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="using-apache-benchmark">Using Apache Benchmark</h3>
<p>We can utilize <a href="http://httpd.apache.org/docs/2.2/programs/ab.html">Apache Benchmark</a> to generate traffic on the service From the console, we will execute the following to generate traffic against our service. Note, we will use a very basic search of just &ldquo;a&rdquo;, since this will generate more results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ab -n <span class="m">1000</span> -c <span class="m">15</span> <span class="s2">&#34;http://localhost:8080/search?q=a&#34;</span>
</span></span></code></pre></div><h3 id="using-loadtest">Using loadtest</h3>
<p>An alternative to Apache Benchmark, is <a href="https://github.com/alexfernandez/loadtest">loadtest</a> (a node.js equivalent). To install:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo npm install -g loadtest
</span></span></code></pre></div><p>Then you can execute similarly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">loadtest -n <span class="m">1000</span> -c <span class="m">15</span> <span class="s2">&#34;http://localhost:8080/search?q=a&#34;</span>
</span></span></code></pre></div><h2 id="stop-flight-recorder">Stop Flight Recorder</h2>
<p>After you have played traffic through the service, you can then stop your flight recording from JMC.</p>
<p><img src="img/jfr-stop.png" alt="jmc_stop"></p>
<p>Then dump the whole recording.</p>
<p><img src="img/jfr-dump.png" alt="jmc_dump"></p>
<h2 id="the-flight-recording">The Flight Recording</h2>
<p>From a Java Flight Recording, there are several categories of information (pages) you can view from JMC:</p>
<ul>
<li>Code Information:
<ul>
<li><strong>Method Profiling</strong>: Provides information about specific method runs and how long each run took, identifying <em>hot spots</em> in your code base.</li>
<li><strong>Exceptions</strong>: Displays Exceptions and Errors thrown and which methods threw them. Viewing exceptions requires editing the settings to also capture Exceptions.</li>
</ul>
</li>
<li>Thread information:
<ul>
<li><strong>Threads</strong>: Provides a snapshot of all the threads that belong to the Java Application and the thread activity.</li>
<li><strong>Lock Instances</strong>: Provides further details on threads by specifying lock information, showing which threads request and which threads take a particular lock.</li>
<li><strong>Thread Dump</strong>: Provides period thread dump information.</li>
</ul>
</li>
<li>Memory Information:
<ul>
<li><strong>Memory</strong>: Represents heap memory usage of the JVM.</li>
</ul>
</li>
<li>IO Information:
<ul>
<li><strong>File I/O</strong>: Displays File costs and behaviors</li>
<li><strong>Socket I/O</strong>: Displays Network costs and behaviors</li>
</ul>
</li>
<li>JVM Internals:
<ul>
<li><strong>Garbage Collections</strong>: Displays heap usage compared to pause times as well as GC events.</li>
<li><strong>Compilations</strong>: Provides details on code compilation.</li>
<li><strong>TLAB Allocations</strong>: Displays Thread Local Allocation Buffers.</li>
</ul>
</li>
<li>System Information:
<ul>
<li><strong>Processes</strong>: See other processes on the system and what is competing for resources.</li>
<li><strong>Environment</strong>: Provides information about the environment in which the recording was made.</li>
<li><strong>System Properties</strong>: Show properties passed on to the JVM.</li>
</ul>
</li>
<li>Events:
<strong>Event Browser</strong>: View detailed log of the events within the JVM. You can use this page to further filter down on events across all the pages in the recording.</li>
</ul>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    Feel free to reference the additional <a href="/docs/jmc/_references/">resources</a> as you navigate through the sections.

</div>

  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll find out more about what our methods are doing.
</p>
        <a href="https://jvmperf.net/docs/jmc/method_profiling/">Method Profiling</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a19b61c681cd81aa3a52b7ab7f00e40a">4.2 - Method Profiling</h1>
    <div class="lead">Gather context of where we spend time in our code</div>
	<p>Our first look at the recording will start with finding out where we might be spending time with our code.</p>
<h3 id="method-profiling-page">Method Profiling Page</h3>
<p>We&rsquo;ll start by taking a look at the detailed <strong>Method Profiling Page</strong>. This page displays how often a specific method is ran based on sampling.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    This page is a little bit difficult to use in JMC7, planned improvements for the data visualization will come in JMC8, see <a href="https://github.com/openjdk/jmc/pull/165">JMC#165</a>

</div>

<p><img src="/jmc/method_profile_page.png" alt=""></p>
<p>By default, this view groups threads by method, but you can also include the line number for each method. This can be accomplished by selecting the <strong>View Menu</strong> option and  going to <strong>Distinguish Frames By</strong> and selecting <strong>Line Number</strong>.</p>
<p><img src="/jmc/method_profile_distinguish_line_numbers.png" alt=""></p>
<p>💡 Generally, you don&rsquo;t need this, as it can be quite apparent by the base method being invoked where the cost is at. Though, it may be helpful to include in some contexts.</p>
<p><img src="/jmc/method_profile_with_line_numbers.png" alt=""></p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    Remember that this is just a sampling view, and does not mean that only a small amount of methods were hit. We&rsquo;ll be able to visualize more of this info in the following part.

</div>

<h2 id="java-application">Java Application</h2>
<p>Navigate to the <strong>Java Application</strong> page. This page provides an overview of the state of the JVM and collates information from a couple of the dedicated pages.</p>
<p><img src="/jmc/java_application_page.png" alt=""></p>
<p>Using the checkboxes on the right of the Graph, select only <strong>Method Profiling</strong> to narrow down the set of events on the graph:</p>
<p><img src="/jmc/java_application_method_profiling.png" alt=""></p>
<p>The <strong>Stack Trace</strong> view from this page can give you a better count of sampled methods (not just the ones from a specific Method Profiling event)</p>
<p><img src="/jmc/java_application_stack_trace.png" alt=""></p>
<p>This information is the equivalent of the <strong>Hot Methods</strong> tab in JMC 5, see <a href="https://community.oracle.com/tech/developers/discussion/4094447/difference-between-method-profiling-and-java-application-stack-traces">forum discussion</a>.</p>
<p>We can then use this information to correlate what is happening in our code:</p>
<p><img src="/jmc/hot_method_line_number.png" alt=""></p>
<h2 id="explore"><i class="fas fa-compass"></i> Explore</h2>
<ul>
<li>Walk around to look at other areas where you are spending time in your code.
<ul>
<li>In many cases you find that there are very expensive areas of code that you cannot change (as you may not own it), but you can dictate whether or not it should be executed (or executed as frequently).</li>
</ul>
</li>
</ul>
<h3 id="follow-ups"><i class="fas fa-question"></i> Follow Ups</h3>
<ul>
<li>Is there any method that stands out to you that might be unnecessarily called?</li>
</ul>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll look at the Exceptions thrown by our application.
</p>
        <a href="https://jvmperf.net/docs/jmc/exceptions/">Exceptions</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8e7ed7a50881f742b2d8880c7a90c384">4.3 - Exceptions</h1>
    <div class="lead">Find the exceptional cases in our application.</div>
	<p>In this section we&rsquo;ll dive into the Exceptions page and find out what information we can learn from it. Start by selecting the <strong>Exceptions</strong> page from the Outline.</p>
<p>This page offers the following sections:</p>
<ul>
<li>Overview: You can get Exceptions by Class and Count</li>
<li>Message: View the detail messages for all exceptions and errors.</li>
<li>Timeline/Event Log: View when a particular exception was thrown.</li>
<li>StackTrace: Identify where the exception was thrown from.</li>
</ul>
<p><img src="/jmc/exceptions_page.png" alt="">.</p>
<p>You can select an exception from the table to filter the information to that particular exception. You could also filter by a particular exception message.</p>
<p><img src="/jmc/exceptions_select_iae.png" alt=""></p>
<h2 id="explore"><i class="fas fa-compass"></i> Explore</h2>
<p><code>NullPointerExceptions</code> are  a familiar exception you deal with in Java, and often times indicate a programming error. Other exception types often point to a common symptom.</p>
<h3 id="follow-ups"><i class="fas fa-question"></i> Follow Ups</h3>
<ul>
<li>What are the exceptions that are getting generated the most?
<ul>
<li>What stack traces are the contributor?</li>
</ul>
</li>
<li>Can you find any areas in our code where we may have made an incorrect assumption regarding nullability?
<ul>
<li>Are there any other areas in our code where we might have made an incorrect assumption based on an exception&rsquo;s class?</li>
</ul>
</li>
<li>Are there any exceptions that might indicate a problem with our dependencies?</li>
</ul>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll look at the Threads used by our application.
</p>
        <a href="https://jvmperf.net/docs/jmc/threads/">Threads</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-140f7f618c6427a75628497db237e231">4.4 - Threads</h1>
    <div class="lead">Find the computation and latency events in your application.</div>
	<p>The <strong>Threads</strong> page provides a snapshot of all threads in our application, and we can use it to acquire information about computation and latency events.</p>
<p><img src="/jmc/threads_page.png" alt=""></p>
<h3 id="thread-chart">Thread Chart</h3>
<p>We can use the Thread Chart view to select a region of time and view the state of threads and the most common stack frames for that particular time slice:</p>
<p><img src="/jmc/thread_chart.png" alt=""></p>
<p>We can also edit the types of events shown by the chart. Right click on the chart, and select <strong>Edit Thread Activity Lanes</strong></p>
<p><img src="/jmc/edit_thread_lanes.png" alt=""></p>
<p>We can then narrow down on specific events.</p>
<p>For the purpose of this section filter on only the <strong>Sleep</strong> events. Then, select a period of time and look at what has caused our threads to go to sleep for that particular period:</p>
<p><img src="/jmc/filter_sleeping_threads.png" alt=""></p>
<p><img src="/jmc/sleeping_threads.png" alt=""></p>
<p>Once you&rsquo;re done with the filtered view, right click on the <strong>Thread</strong> page and Reset the page (to return to the default state).</p>
<p><img src="/jmc/reset_thread_page.png" alt=""></p>
<h3 id="by-thread">By Thread</h3>
<p>We can select an individual thread from the <strong>Thread Table</strong> to further filter the data just for that thread. From this filtered view, we can inspect what the commonly executed methods are for a particular thread.</p>
<p><img src="/jmc/thread_selected.png" alt=""></p>
<p>We can then use the stacktrace view to correlate what piece of code executed the most.</p>
<p><img src="/jmc/thread_selected_stack_trace.png" alt=""></p>
<h2 id="explore"><i class="fas fa-compass"></i> Explore</h2>
<p>There&rsquo;s a couple of threads specifically created by our application, these are the <code>wkshp-conf-loader</code> named threads. The <code>dw-*</code> named threads are threads created by DropWizard to handle specific requests (you might have noticed this based on the name containing a REST Resource). Explore the state of some of these threads while thinking about the follow up questions.</p>
<h3 id="follow-ups"><i class="fas fa-question"></i> Follow Ups</h3>
<ul>
<li>Where are we spending most of our time sleeping? What is causing this?</li>
<li>Are there any unnecessary method invocations? Are any threads doing work that isn&rsquo;t visible?</li>
</ul>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll look at the Memory state of our application.
</p>
        <a href="https://jvmperf.net/docs/jmc/memory/">Memory</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7fa58ef1806796b7bc181181489c25b1">4.5 - Memory</h1>
    <div class="lead">Find the memory cost of events in our application.</div>
	<p>The memory page shows us the overall memory usage and garbage collection events for our recording.</p>
<p><img src="/jmc/memory_page.png" alt=""></p>
<p>The <strong>Class Table</strong> lets us view the total memory allocation dedicated to particular instances of that class. Selecting a particular class will allow us to view what code paths are responsible for creating those objects.</p>
<p><img src="/jmc/memory_class_selected.png" alt=""></p>
<p>We can also filter this view to a particular range in time, for example a range where we went from low to high heap usage:</p>
<p><img src="/jmc/memory_heap_rise.png" alt=""></p>
<p>We can then use this filtered view and drill down through the stack trace to find methods of interest:</p>
<p><img src="/jmc/memory_stack_trace_period.png" alt=""></p>
<h2 id="explore"><i class="fas fa-compass"></i> Explore</h2>
<p>Narrow down through some periods of time where our heap rose quickly and then was collected. Look at the memory reclaimed after each collection.</p>
<h3 id="follow-ups"><i class="fas fa-question"></i> Follow Ups</h3>
<ul>
<li>What are the most commonly allocated classes? Where do they come from?</li>
<li>Are there any classes we own that are also high on the allocation list?</li>
<li>Expand the memory usage chart and only chart the Used Heap, do you notice a pattern?
<ul>
<li>What do you think caused the flat line at the end of the chart?</li>
</ul>
</li>
</ul>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll look at the I/O used by our application.
</p>
        <a href="https://jvmperf.net/docs/jmc/io_operations/">I/O Operations</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-677c02967c93d2d024e0683d7ffa6d55">4.6 - I/O Operations</h1>
    <div class="lead">Find the interactions with external resources.</div>
	<p>The I/O pages can provide context of what external resources you are utilizing from you code base, and relate it to other latency events.</p>
<p>For the purpose of our workshop service, we are doing network I/O, and therefore will look at the <strong>Socket I/O</strong> page.</p>
<p>From this page, we can gain context of what host(s) we are calling, with what frequency, and the cost associated with those calls:</p>
<p><img src="/jmc/io_page.png" alt=""></p>
<p>We can then filter on a particular host and port and drill down into a particular piece of code responsible for that call:</p>
<p><img src="/jmc/io_page_9090.png" alt=""></p>
<h2 id="explore"><i class="fas fa-compass"></i> Explore</h2>
<p>Filter through the total I/O time and explore a couple of events with high I/O.</p>
<h3 id="follow-ups"><i class="fas fa-question"></i> Follow Ups</h3>
<ul>
<li>What remote services are we interacting with?</li>
<li>How long are we interacting with them and how many invocations?</li>
<li>How many times did we make calls and what threads were tied to those calls?</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e82c7a3c3eba03724a0e8df5a3ff19a3">4.7 - References</h1>
    <div class="lead">Collection of useful references used to build this guide.</div>
	<ul>
<li><a href="https://docs.oracle.com/javacomponents/doc/JDMUG/JDMUG.pdf">JDK Mission Control User Guide</a></li>
<li><a href="https://bell-sw.com/announcements/2020/07/22/Hunting-down-code-hotspots-with-JDK-Flight-Recorder/">Hunting down code hotspots with JFR</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6ef11477fa79b0d64946ef4b156240fc">5 - Memory Analysis</h1>
    <div class="lead">Analyzing the JVM heap with available tooling.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b09263a61c61dd500a73a2e9c3ccb14a">5.1 - Memory Heap Analysis</h1>
    <div class="lead">Analyzing the heap of the JVM.</div>
	<p>In the following sections, we are going to do some analysis of the JVM&rsquo;s heap dump.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    Make sure you&rsquo;ve gone through the <a href="/docs/prereqs/">Prerequisites</a>

</div>

<p>First, we&rsquo;ll need to capture a heap dump:</p>
<ul>
<li><a href="/docs/memory/capturing/">Capturing a Heap Dump</a></li>
</ul>
<p>We will then go through three common tools in which we can do some analysis of a heap dump. All of
which are free. :smiley:</p>
<ul>
<li><a href="/docs/memory/joverflow/">JOverflow Analysis</a></li>
<li><a href="/docs/memory/mat/">Eclipse MAT</a></li>
<li><a href="/docs/memory/visualvm/">VisualVM</a></li>
</ul>
<p>We will then tie all our knowledge together and attempt to solve a quick challenge:</p>
<ul>
<li><a href="/docs/memory/challenge/">Memory Challenge</a></li>
</ul>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll learn how to acquire a Heap Dump.
</p>
        <a href="https://jvmperf.net/docs/memory/capturing/">Capturing Heap Dumps</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-035a04a1e49235510f91d61520c4915c">5.2 - Capturing Heap Dumps</h1>
    <div class="lead">Different ways to capture a heap dump.</div>
	<p>You may be aware by now, there are many different ways of getting data from the JVM. Here are just a few ways to get heap dump of the JVM.</p>
<h2 id="jcmd">jcmd</h2>
<p>With <code>jcmd</code>, you have the ability to invoke the <code>GC.heap_dump</code> command. This requires that you
are running as the same OS user as the target JVM process.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">jcmd &lt;PID&gt; GC.heap_dump my_little_heap_dump.hprof
</span></span></code></pre></div><p><strong>Note:</strong> If a full path is not specified, the heap_dump will be created relative to the location from where the process was started (when generated with jcmd)</p>
<h2 id="jmap">jmap</h2>
<p>A more traditional approach is using <code>jmap</code> and invoking the command on the target process.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">jmap -dump:format<span class="o">=</span>b,file<span class="o">=</span>my_little_heap_dump.hprof &lt;PID&gt;
</span></span></code></pre></div><h2 id="core-dump">Core Dump</h2>
<p>You can also use <code>jmap</code> to extract a heap dump from a core dump on the process:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo gdb --pid<span class="o">=</span>&lt;PID&gt;
</span></span><span class="line"><span class="cl">gcore /tmp/jvm.core
</span></span><span class="line"><span class="cl">detach
</span></span><span class="line"><span class="cl">quit
</span></span><span class="line"><span class="cl">jmap -dump:format<span class="o">=</span>b,file<span class="o">=</span>my_little_heap_dump.hprof /usr/bin/java /tmp/jvm.core
</span></span></code></pre></div><p>💡 Capturing a heap dump from a core dump on Java 8, you may run into this issue:
<a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8073606">JDK-8073606</a>.</p>
<h3 id="hotspot-diagnostic-mbean">HotSpot Diagnostic MBean</h3>
<p>You can capture a heap dump by invoking a diagnostic MBean which is included in the Oracle JDK. You can do so by opening your favorite MBean browser (ex. <code>jconsole</code>, <code>jmc</code>) and invoke
the <code>com.sun.management.HotSpotDiagnostic</code>. The arguments are:</p>
<ul>
<li>Filename of the heap dump that will be created. 💡 Note, it will be created with file ownership of the hosting JVM process.</li>
<li>Indicator to dump all live object (true will dump <strong>only live</strong> objects)</li>
</ul>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/hotspot_diag_mbean.png" alt="hotspot_diag"></p>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll start analyzing our heap dump with JOverflow.
</p>
        <a href="https://jvmperf.net/docs/memory/joverflow/">JOverflow</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1f3119da9a3dcd2385759ec01a852380">5.3 - JOverflow</h1>
    <div class="lead">Heap Analysis using JOverflow</div>
	<p>Included in <a href="https://www.oracle.com/java/technologies/jdk-mission-control.html">JDK Mission Control</a> is a plugin that used to be a separate instance, the JOverflow Heap Analyzer. This plugin now adds a context menu selection to <strong>Dump Heap</strong> of JVMs from the JVM Browser.</p>
<p><img src="/joverflow/dump_heap.png" alt="joverflow dump heap"></p>
<p><strong>JOverflow</strong> is a great tool to start our analysis with since it is tailored to identifying common anti-patterns present in most heap dumps. This should give us an idea of the kinds of problems we can see in our JVMs.</p>
<p><img src="/joverflow/main_page.png" alt=""></p>
<h2 id="anti-patterns">Anti-Patterns</h2>
<p>Here is a listing of some the patterns that JOverflow identifies:</p>
<ul>
<li><strong>Empty Unused Collections</strong>: Empty collection, where modification <code>count == 0</code>.</li>
<li><strong>Empty Used Collections</strong>: Empty collection, where modification <code>count != 0</code>.</li>
<li><strong>Small Sparse</strong>: Only for array-based, where less than half the slots are occupied.
Small is considered: size &lt;= default (ex. 16 for HashMap).</li>
<li><strong>Large Sparse</strong>: Only for array-based, where less than half the slots are occupied.
Large is considered: Size &gt; default.</li>
<li><strong>Boxed</strong>: Contains boxed Numbers (ex. java.lang.Integer). Each of these boxed
number has overhead as compared to their primitive counterpart due to object references.</li>
<li><strong>Small Collections</strong>: Collections with 1 to 4 elements. There are fixed costs of collections, which may lend this
set of data better hosted in an array vs. a full Java collection type.</li>
<li><strong>Vertical Bar Collections</strong>: Collection which is a list of lists, where the outer collection
is large, and it&rsquo;s elements are all small collections (ex. List(1000) of List(100))</li>
<li><strong>Zero Size Arrays</strong>: Array where length == 0 (still consumers 12 - 16 bytes).</li>
<li><strong>Vertical Bar Arrays</strong>: Similar to <em>Vertical Bar Collections</em>, but for arrays.</li>
<li><strong>Sparse Arrays</strong>: Less than half of the elements are not null.</li>
<li><strong>Long Zero Tail Arrays</strong>: Ends with a consecutive series of zeros, where the tail length is &gt;= size / 2.</li>
<li><strong>Empty Arrays</strong>: Only null elements.</li>
<li><strong>Duplicate Arrays</strong>: Where an array contents are the same in another instance, but they are separate array instances.</li>
<li><strong>Duplicate Strings</strong>: Same as <em>Duplicate Array</em>, where <code>string1.equals(string2)</code> and <code>string1 != string2</code>.</li>
</ul>
<p>Reference: <a href="https://www.youtube.com/watch?v=b-mv9iWY8kw">JOverflow: Advanced Heap Analysis in JDK Mission Control</a></p>
<h2 id="filtering">Filtering</h2>
<p>As you play with JOverflow, once you click on something, it will begin filtering down your content. If you wish to reduce down to code that you may own, you can start doing a package filter on the ancestor section.</p>
<p>In this example, I want to see duplicate strings for code under <code>cchesser</code>. In this case, I can see that our workshop service has several duplicate
strings (as this content is replicated on each object):</p>
<ul>
<li>Regular Session</li>
<li>4-Hour Workshop</li>
<li>8-Hour Workshop</li>
</ul>
<p>However, the number of instances / overhead is extremely low (since this is a small service), it gives you visibility of areas that you could optimize.</p>
<p><img src="/joverflow/duplicate_strings.png" alt="joverflow filter"></p>
<h3 id="navigating">Navigating</h3>
<p>Since JOverflow&rsquo;s mechanism of drilling down is by applying filters, it doesn&rsquo;t have an easy way to undo most operations, and instead relies on resetting the state to the unfiltered state. You can undo all operations by using the backwards arrow button:</p>
<p><img src="/joverflow/reset.png" alt="joverflow reset"></p>
<h2 id="instances">Instances</h2>
<p>We can also use the plugin to drill down a bit into particular instances.</p>
<p>We can enable the instances view by navigating to:</p>
<ol>
<li>Window &gt; Show View &gt; Other
<img src="/joverflow/window_showview_other.png" alt=""></li>
<li>Selecting JOverflow Instances
<img src="/joverflow/show_instances.png" alt=""></li>
</ol>
<h3 id="example---arrays-size-1">Example - Arrays Size 1</h3>
<p>In the following example, we&rsquo;re going to find:</p>
<ol>
<li>Arrays with One Element
<img src="/joverflow/arrays_one_element.png" alt=""></li>
<li>Coming from our WorkshopConfiguration
<img src="/joverflow/referrer_workshop_configuration.png" alt=""></li>
</ol>
<p>This should filter the Instances view down to that single object.</p>
<p><img src="/joverflow/config_instance.png" alt=""></p>
<h3 id="example---conference-session-details">Example - Conference Session Details</h3>
<p>We can use this same mechanism to also explore values of some of the classes we own, in the next example we&rsquo;re going to:</p>
<ol>
<li>Use All Objects of type Conference Session
<img src="/joverflow/conference_sessions.png" alt=""></li>
<li>Drill down into a couple of the instances
<img src="/joverflow/conference_session_instances.png" alt=""></li>
</ol>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll continue our analysis in Eclipse MAT.
</p>
        <a href="https://jvmperf.net/docs/memory/mat/">Eclipse MAT</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c01af137813ea12c96aaecbb0580e4ae">5.4 - Eclipse MAT</h1>
    <div class="lead">Heap Analysis using Eclipse MAT</div>
	

<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    Make sure you&rsquo;ve gone through the <a href="/docs/prereqs/">Prerequisites</a>

</div>

<p><a href="https://eclipse.org/mat/">Eclipse Memory Analyzer</a> is a fairly mature tool on analyzing heap dumps. It is a rich tool that includes the abilities to do OQL queries on the heap, general reporting on anti-patterns, and helpful common views (like the dominator tree). Eclipse Memory Analyzer tool is a separate install which can be a standalone install, or it can run as a plugin within Eclipse.</p>
<h2 id="opening-heap-dumps">Opening Heap Dumps</h2>
<p>After you have it installed, go to <strong>File</strong> and then <strong>Open Heap Dump&hellip;</strong> and specify the <code>hprof</code> file that you wish to analyze.</p>
<h3 id="index-files">Index Files</h3>
<p>💡 When Eclipse Memory Analyzer loads your <code>hprof</code> file, it will create many other index files to assist in optimally analyzing and navigating through your heap dump. It may make it easier to isolate your <code>prof</code> file in its own directory prior to opening it, based on the secondary files which are created. You can always just delete these files within Eclipse Memory Analyzer by opening the <strong>Heap Dump History</strong> window, right-clicking the <code>hprof</code> which was previously loaded, and selecting <strong>Delete Index Files</strong>. Example listing of index files which get generated by suffix:</p>
<ul>
<li><code>.domIn.index</code></li>
<li><code>.domOut.index</code></li>
<li><code>.index</code></li>
<li><code>.o2ret.index</code></li>
<li><code>.a2s.index</code></li>
<li><code>.idx.index</code></li>
<li><code>.inbound.index</code></li>
<li><code>.o2c.index</code></li>
<li><code>.o2hprof.index</code></li>
<li><code>.outbound.index</code></li>
<li><code>.threads</code></li>
</ul>
<h2 id="analyzing-the-heap-dump">Analyzing the Heap Dump</h2>
<p>In the following section, we&rsquo;ll go through a couple of the views and what sort of data we can gather from them.</p>
<h3 id="dominator-tree">Dominator Tree</h3>
<p>A common first area to look at your heap within Eclipse Memory Analyzer is the dominator tree. From the dominator tree, you can organize by the retained heap size, and then begin drilling down the tree to see the contributors to the largest GC roots.</p>
<p><img src="/mat/dominator_tree.png" alt=""></p>
<h3 id="histogram">Histogram</h3>
<p>The histogram gives you a quick listing of all the top consumers by type. Typically this is going to provide context of the large consumers based on their &ldquo;lower-level&rdquo; types. For example, <code>char[]</code> is a common large contributor, which then will be followed by <code>String</code> which is a type that is predominately weighted by the size of the <code>char[]</code>.</p>
<p><img src="/mat/histogram.png" alt=""></p>
<p>From the histogram, we can drill down into particular instances of an object and see what&rsquo;s referencing them by right clicking on a row and selecting <strong>List Objects</strong> &gt; <strong>with Incoming References</strong></p>
<p><img src="/mat/list_objects_menu.png" alt=""></p>
<p>This should let us drill down into an instance and find what exactly is holding on to that specific value:</p>
<p><img src="/mat/char_array_incoming_refs.png" alt=""></p>
<p>Since this view shows references by incoming link, we would read the results as:</p>
<p>&ldquo;angularjs&rdquo; is pointed to by the <code>[0]</code> index of the <code>tags</code> of a specific <code>ConferenceSession</code> instance, which is pointed to by <code>LocalCache</code>. Notice that this specific example is the inverse of what we found with the dominator tree, if we explored this table enough we would end up at a <code>ConferenceSessionLoader</code> reference.</p>
<h3 id="thread-overview">Thread Overview</h3>
<p>The thread overview is a helpful view when you are looking at contributors based on the execution of code. For example, if you have a JVM which has thrown an <code>OutOfMemoryError</code>, you can tell if some type of request caused a massive spike which caused the exhaustion of memory, or if the requests may have not been abnormal, there just wasn&rsquo;t sufficient space to support the request.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_thread_overview.png" alt="MAT Thread Overview"></p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    <p>It may be the case that the thread that has the OutOfMemoryError in its stack is not the root cause. Consider the following example:</p>
<ul>
<li>We have a max heap of 128 Mb.</li>
<li>A request comes in that produces a 125Mb <code>int[]</code></li>
<li>A second request comes in that produces a 5Mb <code>int[]</code>.</li>
</ul>
<p>The JVM would potentially throw the OutOfMemory on that second request, since there&rsquo;s not enough memory to allocate 5Mb, however, it might be the case that the code path for the initial request is allocating memory unnecessarily.</p>


</div>

<h3 id="oql">OQL</h3>
<p>Another strong feature of Eclipse Memory Analyzer is the OQL studio to execute queries to do lookup on objects in your heap.</p>
<p>Lookup our <code>ConferenceSession</code> class type:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">INSTANCEOF</span><span class="w"> </span><span class="n">cchesser</span><span class="p">.</span><span class="n">javaperf</span><span class="p">.</span><span class="n">workshop</span><span class="p">.</span><span class="k">data</span><span class="p">.</span><span class="n">ConferenceSession</span><span class="w">
</span></span></span></code></pre></div><p>💡 To execute the query, you click on the red exclamation mark (:exclamation:). Alternatively, you can press <code>CTRL+Enter</code> on Windows or <code>Command+Enter</code> on macOS.</p>
<p><img src="https://github.com/cchesser/java-perf-workshop/wiki/images/mat_oql_studio.png" alt="MAT OQL"></p>
<p>By returning the raw type back, you can expand each one to further look at the contents of the object. If you wanted to just report the object with its <code>title</code> attribute and the object&rsquo;s retained sized, you could do this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">title</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="o">@</span><span class="n">retainedHeapSize</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">INSTANCEOF</span><span class="w"> </span><span class="n">cchesser</span><span class="p">.</span><span class="n">javaperf</span><span class="p">.</span><span class="n">workshop</span><span class="p">.</span><span class="k">data</span><span class="p">.</span><span class="n">ConferenceSession</span><span class="w"> </span><span class="k">c</span><span class="w"> 
</span></span></span></code></pre></div><p>Now, you could then filter this by including a <code>WHERE</code> clause, where you can filter it by
the title or the abstract:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">title</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="o">@</span><span class="n">retainedHeapSize</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">INSTANCEOF</span><span class="w"> </span><span class="n">cchesser</span><span class="p">.</span><span class="n">javaperf</span><span class="p">.</span><span class="n">workshop</span><span class="p">.</span><span class="k">data</span><span class="p">.</span><span class="n">ConferenceSession</span><span class="w"> </span><span class="k">c</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">title</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s2">&#34;.*(J|j)ava.*&#34;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">abstract</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s2">&#34;.*(J|j)ava.*&#34;</span><span class="w">
</span></span></span></code></pre></div><p>Reference: <a href="http://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Freference%2Foqlsyntax.html">Eclipse Memory Analyzer OQL Syntax</a></p>
<p>The auto-completion will also let you invoke fields and method&rsquo;s from Eclipse Mat&rsquo;s own <a href="https://wiki.eclipse.org/MemoryAnalyzer/Reading_Data_from_Heap_Dumps#The_object_model">internal model</a> for the heap dump. You can view other methods available by exploring the <a href="http://127.0.0.1:64030/help/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Fdoc%2Forg%2Feclipse%2Fmat%2Fsnapshot%2Fmodel%2FIObject.html">API Reference</a></p>
<p><img src="/mat/mat_oql_model_invocation.png" alt=""></p>
<h2 id="useful-plugins">Useful Plugins</h2>
<h3 id="calcite-mat">Calcite MAT</h3>
<p>The <a href="https://github.com/vlsi/mat-calcite-plugin">Calcite MAT Plugin</a> adds sort, group by and join behavior (among other things) and an additional SQL query engine.</p>
<p>We can use this plugin to do some more advanced analysis, for example:</p>
<ul>
<li>Getting a distribution of the number of tags in our ConferenceSessions</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">getSize</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">tags</span><span class="p">)</span><span class="w"> </span><span class="n">tag_cnt</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">getSize</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">tags</span><span class="p">))</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="s2">&#34;cchesser.javaperf.workshop.data.ConferenceSession&#34;</span><span class="w"> </span><span class="k">c</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">tag_cnt</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">tag_cnt</span><span class="w"> </span><span class="k">desc</span><span class="w">
</span></span></span></code></pre></div><p><img src="/mat/calcite_tag_distributions.png" alt=""></p>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll continue our analysis in VisualVM.
</p>
        <a href="https://jvmperf.net/docs/memory/visualvm/">VisualVM</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-de268a519541f36805c09c8812e06816">5.5 - VisualVM</h1>
    <div class="lead">Heap Analysis using VisualVM</div>
	

<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    Make sure you&rsquo;ve gone through the <a href="/docs/prereqs/">Prerequisites</a>

</div>

<p><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/visualvm/">VisualVM</a> is a tool which used to be part of Oracle&rsquo;s JDK and is now a <a href="https://visualvm.github.io/">standalone tool</a>. This tool was spawned from the <a href="https://profiler.netbeans.org/">Netbeans Profiler</a>, and it has some helpful tools to inspect a heap dump.</p>
<h2 id="opening-dumps">Opening Dumps</h2>
<p>To load the heap dump in VisualVM, you will just go to <strong>File</strong> -&gt; <strong>Load&hellip;</strong> and specify the
<strong>File Format</strong> to be <strong>Heap Dumps&hellip;</strong>.</p>
<p><img src="/visualvm/load_dump.png" alt=""></p>
<h2 id="analyzing-the-heap-dump">Analyzing the Heap Dump</h2>
<p>VisualVM offers the following sections:</p>
<ul>
<li>Summary</li>
<li>Objects</li>
<li>Threads</li>
<li>OQL Console</li>
<li>R Console</li>
</ul>
<p>For the purpose of this section we are only going to utilize the <strong>OQL Console</strong> to construct
queries on the heap. There are other options in VisualVM (briefly discussed here), but we feel that the other tools presented before this offer much nicer views/data.</p>
<h3 id="summary">Summary</h3>
<p>The <strong>Summary</strong> view gives you a quick overview of the state of the heap:</p>
<p><img src="/visualvm/summary.png" alt=""></p>
<p>This view also lets you quickly gather the dominators for the heap, similar to the Dominator Tree in Eclipse MAT.</p>
<p><img src="/visualvm/dominators.png" alt=""></p>
<h3 id="objects">Objects</h3>
<p>The <strong>Objects</strong> view groups instances by class.</p>
<p><img src="/visualvm/objects.png" alt=""></p>
<p>Within this view, you can inspect individual instances of an object and see both the fields and the incoming references to that instance:</p>
<p><img src="/visualvm/objects_expanded.png" alt=""></p>
<h3 id="threads">Threads</h3>
<p>The <strong>Threads</strong> view visualizes the state of threads.</p>
<p><img src="/visualvm/threads.png" alt=""></p>
<p>Within this view, you can drill down into certain threads and view what was specifically referenced in a stack frame:</p>
<p><img src="/visualvm/threads_expanded.png" alt=""></p>
<h3 id="oql-console">OQL Console</h3>
<p>One of the attractive features for VisualVM is that its <strong>OQL Console</strong> allows you to write Javascript code to query objects, which you can then do other functions on that data.</p>
<p>From the <strong>OQL Console</strong>, we will issue queries and then allow you to further play around with the language.</p>
<h2 id="oql-queries">OQL Queries</h2>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    The OQL which you use between this tool (and others), isn&rsquo;t necessarily <em>standard</em>, and therefore cannot be used between tooling without issues. VisualVM gives you
the ability to leverage Javascript, which is unique to other tools supporting heap dump analysis.

</div>

<p>Reference: <a href="https://htmlpreview.github.io/?https://raw.githubusercontent.com/visualvm/visualvm.java.net.backup/master/www/oqlhelp.html">VisualVM OQL Help</a></p>
<h3 id="deamon-threads">Deamon Threads</h3>
<p>Query for Thread objects which are daemons (you can get context of Threads, since they
are objects in your heap too):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">select</span> <span class="nx">t</span> <span class="nx">from</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Thread</span> <span class="nx">t</span> <span class="nx">where</span> <span class="nx">t</span><span class="p">.</span><span class="nx">daemon</span> <span class="o">==</span> <span class="kc">true</span>
</span></span></code></pre></div><p>Previous versions of VisualVM used to return the results as hyperlinks, which you could then click
and begin diving into the instance state:</p>
<p><img src="/visualvm/oql_sample_results_links.png" alt=""></p>
<p>The newer versions of VisualVM will populate the results in a view similar to the <strong>Objects</strong> view:</p>
<p><img src="/visualvm/oql_sample_results.png" alt=""></p>
<h3 id="mapping-to-json">Mapping to JSON</h3>
<p>Query for Thread objects (similar to last query), but return multiple attributes as JSON:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">select</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">thread_id</span><span class="o">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">tid</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">from</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Thread</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl"><span class="nx">where</span> <span class="nx">t</span><span class="p">.</span><span class="nx">daemon</span> <span class="o">==</span> <span class="kc">true</span>
</span></span></code></pre></div><p><img src="/visualvm/sample_json_results.png" alt=""></p>
<h3 id="applying-javascript">Applying Javascript</h3>
<p>VisualVM offers a helper object that represents the heap, the <code>heap</code> object, which offers a few useful functions.</p>
<p><img src="/visualvm/oql_heap_object.png" alt=""></p>
<p>During our OQL searching, we&rsquo;ll be using <code>heap.objects</code> to gather the set of objects we want.</p>
<p>We&rsquo;ll start by limiting our objects to instances of <code>cchesser.javaperf.workshop.data.ConferenceSession</code> and assign it to a variable called <code>sessions</code> (which we&rsquo;ll reference later).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">sessions</span> <span class="o">=</span> <span class="nx">heap</span><span class="p">.</span><span class="nx">objects</span><span class="p">(</span><span class="s1">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span class="p">);</span>
</span></span></code></pre></div><p>We&rsquo;re going to find ConferenceSessions that which have <em>tags</em>, we&rsquo;ll do that by writing a Javascript function to filter results which have <em>tags</em>. We&rsquo;ll apply this filter to our <code>sessions</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">sessions</span> <span class="o">=</span> <span class="nx">heap</span><span class="p">.</span><span class="nx">objects</span><span class="p">(</span><span class="s1">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">hasTags</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">filter</span><span class="p">(</span><span class="nx">sessions</span><span class="p">,</span> <span class="nx">hasTags</span><span class="p">);</span>
</span></span></code></pre></div><p><img src="/visualvm/oql_hasTags.png" alt=""></p>
<p>Take that previous query and further expand it to list it in JSON with the number of tags. It is often times convenient to have a reference to the object we&rsquo;re interacting with, to more easily see the available fields.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">sessions</span> <span class="o">=</span> <span class="nx">heap</span><span class="p">.</span><span class="nx">objects</span><span class="p">(</span><span class="s1">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">hasTags</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">withTags</span> <span class="o">=</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">sessions</span><span class="p">,</span> <span class="nx">hasTags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="p">{</span> <span class="nx">conference</span><span class="o">:</span> <span class="nx">conf</span> <span class="p">,</span> <span class="nx">tagCount</span> <span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">size</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">map</span><span class="p">(</span><span class="nx">withTags</span><span class="p">,</span> <span class="nx">toJSON</span><span class="p">);</span>
</span></span></code></pre></div><p><img src="/visualvm/oql_hasTags_json.png" alt=""></p>
<p>We can further expand this to sort the results, descending by number of tags, and list the tags in the results:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">sessions</span> <span class="o">=</span> <span class="nx">heap</span><span class="p">.</span><span class="nx">objects</span><span class="p">(</span><span class="s1">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">hasTags</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">withTags</span> <span class="o">=</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">sessions</span><span class="p">,</span> <span class="nx">hasTags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span> <span class="nx">conference</span><span class="o">:</span> <span class="nx">conf</span> <span class="p">,</span> <span class="nx">tagCount</span> <span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">size</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">confs</span> <span class="o">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">withTags</span><span class="p">,</span> <span class="nx">toJSON</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">tagSorter</span><span class="p">(</span><span class="nx">lhs</span><span class="p">,</span> <span class="nx">rhs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">rhs</span><span class="p">.</span><span class="nx">tagCount</span> <span class="o">-</span> <span class="nx">lhs</span><span class="p">.</span><span class="nx">tagCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">sort</span><span class="p">(</span><span class="nx">confs</span><span class="p">,</span> <span class="nx">tagSorter</span><span class="p">);</span>
</span></span></code></pre></div><p><img src="/visualvm/oql_tags_sorted.png" alt=""></p>
<p>We could also inline most of this using the inline syntax:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">hasTags</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">sort</span><span class="p">(</span><span class="nx">map</span><span class="p">(</span><span class="nx">filter</span><span class="p">(</span><span class="nx">heap</span><span class="p">.</span><span class="nx">objects</span><span class="p">(</span><span class="s1">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span class="p">),</span> <span class="nx">hasTags</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl"> <span class="s1">&#39;{ conference: it, tag_count: it.tags.size, tags: toArray(it.tags.elementData) }&#39;</span><span class="p">),</span> <span class="s1">&#39;rhs.tag_count - lhs.tag_count&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="/visualvm/oql_tags_inline.png" alt=""></p>
<h2 id="useful-plugins">Useful Plugins</h2>
<h3 id="oql-syntax-support">OQL Syntax Support</h3>
<p>This plugin adds some auto complete and syntax highlighting to the OQL Console</p>
<p><img src="/visualvm/oql_syntax_plugin.png" alt=""></p>
<h2 id="challenge"><i class="fas fa-atlas"></i> Challenge</h2>
<p>Apply what you&rsquo;ve learned about OQL in this section and write some javascript that will show the distribution of tag counts in our conference sessions (similar to what we did with calcite mat.)</p>
<h3 id="sample-solutions">Sample Solutions</h3>
<h4 id="json-output">JSON Output</h4>
<p>This solution will return the result as a JSON object.</p>
<script>
    function toggleContent(button) {
        var content = button.parentElement.getElementsByClassName('spoiler-content')[0];
        content.hidden = !content.hidden;
    }
</script>
<div class="spoiler-container">
  <button onclick="toggleContent(this)">Show JSON</button>
  <div class="spoiler-content" hidden>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">sessions</span> <span class="o">=</span> <span class="nx">heap</span><span class="p">.</span><span class="nx">objects</span><span class="p">(</span><span class="s1">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span> <span class="nx">conference</span><span class="o">:</span> <span class="nx">conf</span> <span class="p">,</span> <span class="nx">tagCount</span> <span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">tags</span> <span class="o">?</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">title</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">confs</span> <span class="o">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">sessions</span><span class="p">,</span> <span class="nx">toJSON</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">confs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">conf</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">tagCount</span><span class="p">])</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="nx">results</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">tagCount</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">results</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">tagCount</span><span class="p">]</span> <span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">tagCount</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">results</span>
</span></span></code></pre></div><p><img src="/visualvm/tag_distributions_json.png" alt=""></p>
  </div>
</div>
<h4 id="html-output">HTML Output</h4>
<p>This solution will return the result as an HTML <code>&lt;ul&gt;</code>.</p>
<script>
    function toggleContent(button) {
        var content = button.parentElement.getElementsByClassName('spoiler-content')[0];
        content.hidden = !content.hidden;
    }
</script>
<div class="spoiler-container">
  <button onclick="toggleContent(this)">Show HTML</button>
  <div class="spoiler-content" hidden>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">sessions</span> <span class="o">=</span> <span class="nx">heap</span><span class="p">.</span><span class="nx">objects</span><span class="p">(</span><span class="s1">&#39;cchesser.javaperf.workshop.data.ConferenceSession&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span> <span class="nx">conference</span><span class="o">:</span> <span class="nx">conf</span> <span class="p">,</span> <span class="nx">tagCount</span> <span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">tags</span> <span class="o">?</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">title</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">confs</span> <span class="o">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">sessions</span><span class="p">,</span> <span class="nx">toJSON</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">confs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">maxSize</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="nx">map</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="s1">&#39;it.tagCount&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">maxSize</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">conf</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nx">results</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">tagCount</span><span class="p">]</span><span class="o">++</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">report</span> <span class="o">=</span> <span class="s2">&#34;&lt;html&gt;&lt;ul&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">maxSize</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nx">report</span> <span class="o">+=</span> <span class="s2">&#34;&lt;li&gt;&lt;b&gt;Size(&#34;</span> <span class="o">+</span><span class="nx">i</span><span class="o">+</span><span class="s2">&#34;)&lt;/b&gt;=&#34;</span><span class="o">+</span><span class="nx">count</span><span class="o">+</span><span class="s2">&#34;&lt;/li&gt;&#34;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">report</span><span class="o">+=</span><span class="s2">&#34;&lt;/ul&gt;&lt;/html&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">toHtml</span><span class="p">(</span><span class="nx">report</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="/visualvm/tag_distributions_html.png" alt=""></p>
  </div>
</div>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll test our knwolege.
</p>
        <a href="https://jvmperf.net/docs/memory/challenge/">Memory Challenge</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-605fd19420eabae15eb4ac1d0e6b77d1">5.6 - Memory Challenge</h1>
    <div class="lead">Put all the pieces together with this challenge to test your skills</div>
	<p>The provided WorkshopService has an intentional memory problem, use the previous sections as reference to try to pin point it.</p>
<h2 id="tips">Tips</h2>
<ul>
<li>With the Dominator Tree (Eclipse MAT) determine what object would free up the most memory (if we could get rid of it)</li>
<li>With the Histogram (Eclipse MAT) determine what type of object has the most instances
<ul>
<li>Using the Incoming Objects view, find out what&rsquo;s pointing to them.</li>
</ul>
</li>
</ul>
<p>Once you&rsquo;ve found the large object, look through it&rsquo;s properties and determine why this object holds on to so many other objects.</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Solution</h4>

    This section contains a solution, make sure you&rsquo;ve given things a shot before spoiling the fun.

</div>

<script>
    function toggleContent(button) {
        var content = button.parentElement.getElementsByClassName('spoiler-content')[0];
        content.hidden = !content.hidden;
    }
</script>
<div class="spoiler-container">
  <button onclick="toggleContent(this)">Show Solution</button>
  <div class="spoiler-content" hidden>
<h2 id="dominator-tree">Dominator Tree</h2>
<p>A first glance at the dominator tree will point us to a <code>io.dropwizard.jetty.MutableServletContextHandler</code>, which is something controlled by the DropWizard framework. Let&rsquo;s dig through its references until we find some classes in the <code>cchesser</code> package.</p>
<p><img src="/mem_challenge/dominator_tree_start.png" alt=""></p>
<p>The first instance of a class we &ldquo;own&rdquo; is <code>cchesser.javaperf.workshop.resources.WorkshopResource</code></p>
<p><img src="/mem_challenge/dominator_tree_resource.png" alt=""></p>
<p>Let&rsquo;s look at it&rsquo;s properties a bit, and we&rsquo;ll find a <code>cchesser.javaperf.workshop.cache.CleverCache</code> reference with about 70% of the memory consumption.</p>
<p><img src="/mem_challenge/dominator_tree_clever_cache.png" alt=""></p>
<p>We&rsquo;ll look at its properties in a bit more detail in the following sections.</p>
<h2 id="histogram-view">Histogram View</h2>
<p>A first glance at the Histogram View (sorted by retained heap), shows us about 2,000,000 instances of <code>cchesser.javaperf.workshop.data.Searcher$SearchResultElement</code></p>
<p><img src="/mem_challenge/histogram.png" alt=""></p>
<p>Looking through the references to an instance of this type, we end up being referenced by the <code>data</code> field in <code>cchesser.javaperf.workshop.cache.CleverCache$CacheEntry</code></p>
<p><img src="/mem_challenge/sre_incoming_refs.png" alt=""></p>
<p>We can further inspect the Incoming References for a particular entry, and see what is pointing to it, tracing it back to something we own:</p>
<p><img src="/mem_challenge/cc_entry_incoming_refs.png" alt=""></p>
<p>Once again, we&rsquo;ve ended up at <code>cchesser.javaperf.workshop.resources.WorkshopResource</code>, specifically a field called <code>resultsByContext</code>.</p>
<p>We&rsquo;ll take a closer look at this <code>cchesser.javaperf.workshop.cache.CleverCache</code> object.</p>
<h2 id="inspecting-clever-cache">Inspecting Clever Cache</h2>
<p>First, lets determine how many instances of <code>cchesser.javaperf.workshop.cache.CleverCache</code> we have. We&rsquo;ve found a single instance that is about 70Mb (in our sample dump), so let&rsquo;s double check if there&rsquo;s more of these.</p>
<p>We can do that in a couple of ways:</p>
<ol>
<li>Use the histogram view to filter on <code>CleverCache</code></li>
</ol>
<p><img src="/mem_challenge/mat_clevercache_instance.png" alt=""></p>
<ol start="2">
<li>Use OQL to find instances of that object:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">cchesser</span><span class="p">.</span><span class="n">javaperf</span><span class="p">.</span><span class="n">workshop</span><span class="p">.</span><span class="k">cache</span><span class="p">.</span><span class="n">CleverCache</span><span class="w">
</span></span></span></code></pre></div><p><img src="/mem_challenge/mat_oql_clevercache.png" alt=""></p>
<h3 id="fieldsreferences">Fields/References</h3>
<p>We can find the fields and references for an instance using either Eclipse MAT or VisualVM.</p>
<p>In Eclipse Mat, the fields for an instance display in an <strong>Attributes</strong> tab</p>
<p><img src="/mem_challenge/mat_cc_instance.png" alt=""></p>
<p>In VisualVM, we can load the <strong>Objects</strong> view and apply a filter on class name to then inspect the fields and references</p>
<p><img src="/mem_challenge/visualvm_cc_instance.png" alt=""></p>
<p>Looking at the properties, we find that there&rsquo;s a <code>cacheLimit</code> of <code>250</code>. Let&rsquo;s find out exactly how many entries are in the cache (the <code>innerCache</code> field).</p>
<h2 id="finding-sizes">Finding Sizes</h2>
<p>Let&rsquo;s write a query that will show us what the count of entries in the cache is.</p>
<ul>
<li>For our query, we need to pull the <code>cacheLimit</code> and <code>size</code> of the <code>innerCache</code> map,</li>
</ul>
<p>We can do this a few ways:</p>
<h3 id="eclipse-mat--oql">Eclipse MAT / OQL</h3>
<p>we can do that with the following query:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">cacheLimit</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;max entries&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">innerCache</span><span class="p">.</span><span class="k">size</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cchesser</span><span class="p">.</span><span class="n">javaperf</span><span class="p">.</span><span class="n">workshop</span><span class="p">.</span><span class="k">cache</span><span class="p">.</span><span class="n">CleverCache</span><span class="w"> </span><span class="k">c</span><span class="w"> 
</span></span></span></code></pre></div><p><img src="/mem_challenge/oql_size_report.png" alt=""></p>
<h3 id="eclipse-mat--calcite">Eclipse MAT / Calcite</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">cacheLimit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s2">&#34;max entries&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">getSize</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">innerCache</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s2">&#34;entries&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">cchesser</span><span class="p">.</span><span class="n">javaperf</span><span class="p">.</span><span class="n">workshop</span><span class="p">.</span><span class="k">cache</span><span class="p">.</span><span class="n">CleverCache</span><span class="w"> </span><span class="k">c</span><span class="w">
</span></span></span></code></pre></div><p><img src="/mem_challenge/calcite_size_report.png" alt=""></p>
<h3 id="visualvm--oql">VisualVM / OQL</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">caches</span> <span class="o">=</span> <span class="nx">heap</span><span class="p">.</span><span class="nx">objects</span><span class="p">(</span><span class="s2">&#34;cchesser.javaperf.workshop.cache.CleverCache&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">report</span><span class="p">(</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span> <span class="nx">maxEntries</span><span class="o">:</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">cacheLimit</span><span class="p">,</span> <span class="nx">entries</span><span class="o">:</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">innerCache</span><span class="p">.</span><span class="nx">size</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="nx">map</span><span class="p">(</span><span class="nx">caches</span><span class="p">,</span> <span class="nx">report</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="/mem_challenge/visualvm_size_report.png" alt=""></p>
<div class="pageinfo pageinfo-warning">
<p>That doesn&rsquo;t seem right at all, we want at most 250 items but we have about 10,000. Let&rsquo;s find out why that is the case.</p>
</div>
<h2 id="memory-problem-explained">Memory Problem Explained</h2>
<p>The interaction between the <code>WorkshopResource</code> and <code>CleverCache</code> happens through the <code>/search</code> resource.</p>
<p><em>cchesser.javaperf.workshop.WorkshopResource</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Path</span><span class="p">(</span><span class="s">&#34;/search&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Produces</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Timed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Searcher</span><span class="p">.</span><span class="na">SearchResult</span><span class="w"> </span><span class="nf">searchConference</span><span class="p">(</span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&#34;q&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">term</span><span class="p">,</span><span class="w"> </span><span class="nd">@QueryParam</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fetchResults</span><span class="p">(</span><span class="n">term</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">Searcher</span><span class="p">.</span><span class="na">SearchResult</span><span class="w"> </span><span class="nf">fetchResults</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">term</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">context</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resultsByContext</span><span class="p">.</span><span class="na">exists</span><span class="p">(</span><span class="n">context</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">resultsByContext</span><span class="p">.</span><span class="na">fetch</span><span class="p">(</span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// does not exist in cache, compute and store</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">SearchResult</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">searcher</span><span class="p">.</span><span class="na">search</span><span class="p">(</span><span class="n">term</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">resultsByContext</span><span class="p">.</span><span class="na">store</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="na">getResultsContext</span><span class="p">(),</span><span class="w"> </span><span class="n">results</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">results</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>If a context is sent, the previously cached values for the search are returned, otherwise we cache those result values in case they need to be referenced again.</p>
<p><em>javaperf.workshop.cache.CleverCache</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Stores the given key value pair in the cache
</span></span></span><span class="line"><span class="cl"><span class="cm">  *
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @param key   the unique identifier associated with the given value
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @param value the value mapped to the given key
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">store</span><span class="p">(</span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isFull</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">K</span><span class="w"> </span><span class="n">keyToRemove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getLFUKey</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CleverCache</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="p">.</span><span class="na">CacheEntry</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">removedEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">innerCache</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">keyToRemove</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CacheEntry</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">newEntry</span><span class="p">.</span><span class="na">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">newEntry</span><span class="p">.</span><span class="na">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">innerCache</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">newEntry</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// other methods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isFull</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">innerCache</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cacheLimit</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>This interaction is <strong>NOT</strong> thread safe. Consider this scenario:</p>
<ul>
<li>Thread 1 invokes <code>store</code> when the <code>innerCache.size()</code> is <code>249</code>
<ul>
<li><code>isFull()</code> evaluates to <code>false</code></li>
<li>Execution halts prior to <code>innerCache.put</code></li>
</ul>
</li>
<li>Thread 2 invokes <code>store</code> when the <code>innerCache.size()</code> is <code>249</code>
<ul>
<li><code>isFull()</code> evaluates to false</li>
<li>Execution halts prior to <code>innerCache.put</code></li>
</ul>
</li>
<li>Thread 1 resumes and executes <code>innerCache.put</code>, <code>innerCache.size()</code> is now <code>250</code></li>
<li>Thread 2 resumes and executes <code>innerCache.put</code>, <code>innerCache.size()</code> is now <code>251</code></li>
<li>For the lifecycle of the jvm <code>isFull()</code> will no longer return <code>true</code></li>
</ul>
<p>Fortunately, the DropWizard documentation calls out the need to consider thread safety:</p>
<p><img src="/mem_challenge/dw_thread_safety.png" alt=""></p>
<p>Since the <code>WorkshopResource</code> has a <code>resultsByContext</code> field that will get shared across threads, that type should be thread safe.</p>
<h3 id="potential-solutions">Potential Solutions</h3>
<ul>
<li>
<p>The naive solution would be to just change <code>isFull()</code> to consider <code>&gt;=</code>, though that might lead to ConcurrentModificationExceptions</p>
</li>
<li>
<p>The proper solution would be to make the class Thread Safe</p>
</div>
</li>
</ul>
</div>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll continue learn about Garbage Collection logs.
</p>
        <a href="https://jvmperf.net/docs/memory/gc/">Garbage Collections</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c6512c461f5f3bf1ba4ced486f736874">5.7 - Garbage Collections</h1>
    <div class="lead">Analyzing garbage collections of the JVM</div>
	<p>A key piece to understanding what is happening in terms of GC cycles within your service,
is enabling GC logs. In this section, we are going to do some analysis on the JVM in regards to it&rsquo;s garbage collection (GC)
cycles.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Prerequisite</h4>

    <a href="https://www.r-project.org/">R environment</a> <em>(If you want to try parsing some of the logs)</em>

</div>

<h2 id="gc-jvm-options">GC JVM Options</h2>
<p>Here is a set of JVM options you can enable on your service and how to interpret those logs.</p>
<ul>
<li><code>-XX:+PrintGCDetails</code>: Includes more details within your GC log</li>
<li><code>-XX:+PrintGCDateStamps</code>: Have a readable date/time string to correlate events in your log. Without
this option, your GC log will have elapsed time since the JVM was started. This format (which is reported)
in seconds (with millisecond precision), is not easy for someone to quickly correlate when this event was
logged (as you have to infer the time based on when the JVM was started).</li>
<li><code>-Xloggc</code>: Specifies the log file for the garbage collection logs (otherwise will go to stdout).
💡 Note: <code>-verbose:gc</code> is NOT necessary when you set <code>Xloggc</code> (it is implied).</li>
<li><code>-XX:+UseGCLogFileRotation</code>: Support rotating your GC log file (you don&rsquo;t want to let this get too
big).</li>
<li><code>-XX:GCLogFileSize</code>: Size of the file for rotation (ex. <code>10M</code>).</li>
<li><code>-XX:NumberOfGCLogFiles</code>: Number of GC log files to maintain (ex. <code>3</code>). 💡 Note: if you are monitoring
your log file with another solution (like <a href="http://www.splunk.com/">splunk</a> or
<a href="https://www.elastic.co/products/logstash">logstash</a>), you typically don&rsquo;t need to be keeping an inventory of
rolled files around, unless you are concerned about log forwarding failing and want to ensure a given amount
is still capable of being captured from a host.</li>
</ul>
<h2 id="gc-log-formats">GC Log formats</h2>
<p>With different garbage collectors in the JVM, you will get slightly different GC log formats.</p>
<h3 id="parallel-gc">Parallel GC</h3>
<pre tabindex="0"><code>2015-09-30T10:57:20.215+0600: 0.847: [GC (Allocation Failure) [PSYoungGen: 65536K-&gt;10748K(76288K)] 65536K-&gt;12607K(251392K), 0.0118637 secs] [Times: user=0.03 sys=0.01, real=0.01 secs]
2015-09-30T10:57:20.556+0600: 1.188: [GC (Metadata GC Threshold) [PSYoungGen: 44312K-&gt;10748K(141824K)] 46171K-&gt;12786K(316928K), 0.0077755 secs] [Times: user=0.03 sys=0.00, real=0.01 secs]
2015-09-30T10:57:20.564+0600: 1.196: [Full GC (Metadata GC Threshold) [PSYoungGen: 10748K-&gt;0K(141824K)] [ParOldGen: 2038K-&gt;10444K(116736K)] 12786K-&gt;10444K(258560K), [Metaspace: 20976K-&gt;20976K(1067008K)], 0.0286381 secs] [Times: user=0.14 sys=0.01, real=0.03 secs]
</code></pre><h3 id="concurrent-mark-sweep">Concurrent Mark Sweep</h3>
<pre tabindex="0"><code>2015-09-30T11:11:35.994+0600: 0.838: [GC (Allocation Failure) 0.838: [ParNew: 69952K-&gt;8703K(78656K), 0.0128204 secs] 69952K-&gt;12781K(253440K), 0.0128848 secs] [Times: user=0.04 sys=0.01, real=0.01 secs]
2015-09-30T11:11:38.009+0600: 2.853: [GC (CMS Initial Mark) [1 CMS-initial-mark: 4077K(174784K)] 67493K(253440K), 0.0088311 secs] [Times: user=0.04 sys=0.00, real=0.01 secs]
2015-09-30T11:11:38.018+0600: 2.862: [CMS-concurrent-mark-start]
2015-09-30T11:11:38.018+0600: 2.862: [CMS-concurrent-mark: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
2015-09-30T11:11:38.018+0600: 2.862: [CMS-concurrent-preclean-start]
2015-09-30T11:11:38.019+0600: 2.863: [CMS-concurrent-preclean: 0.001/0.001 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]
2015-09-30T11:11:38.019+0600: 2.863: [CMS-concurrent-abortable-preclean-start]
 CMS: abort preclean due to time 2015-09-30T11:11:43.074+0600: 7.918: [CMS-concurrent-abortable-preclean: 1.233/5.055 secs] [Times: user=1.23 sys=0.01, real=5.06 secs]
2015-09-30T11:11:43.074+0600: 7.918: [GC (CMS Final Remark) [YG occupancy: 63415 K (78656 K)]7.918: [Rescan (parallel) , 0.0052614 secs]7.924: [weak refs processing, 0.0000337 secs]7.924: [class unloading, 0.0029068 secs]7.927: [scrub symbol table, 0.0025781 secs]7.929: [scrub string table, 0.0002699 secs][1 CMS-remark: 4077K(174784K)] 67493K(253440K), 0.0117740 secs] [Times: user=0.04 sys=0.01, real=0.01 secs]
2015-09-30T11:11:43.086+0600: 7.930: [CMS-concurrent-sweep-start]
2015-09-30T11:11:43.086+0600: 7.930: [CMS-concurrent-sweep: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
2015-09-30T11:11:43.087+0600: 7.930: [CMS-concurrent-reset-start]
2015-09-30T11:11:43.110+0600: 7.954: [CMS-concurrent-reset: 0.023/0.023 secs] [Times: user=0.01 sys=0.01, real=0.03 secs]
</code></pre><h3 id="g1">G1</h3>
<pre tabindex="0"><code>015-09-30T11:13:03.870+0600: 0.395: [GC pause (G1 Evacuation Pause) (young), 0.0052206 secs]
   [Parallel Time: 1.9 ms, GC Workers: 8]
      [GC Worker Start (ms): Min: 395.4, Avg: 395.5, Max: 395.8, Diff: 0.3]
      [Ext Root Scanning (ms): Min: 0.0, Avg: 0.3, Max: 1.1, Diff: 1.1, Sum: 2.0]
      [Update RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]
         [Processed Buffers: Min: 0, Avg: 0.0, Max: 0, Diff: 0, Sum: 0]
      [Scan RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [Code Root Scanning (ms): Min: 0.0, Avg: 0.1, Max: 0.4, Diff: 0.4, Sum: 0.5]
      [Object Copy (ms): Min: 0.7, Avg: 1.4, Max: 1.6, Diff: 0.9, Sum: 11.4]
      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [GC Worker Total (ms): Min: 1.5, Avg: 1.8, Max: 1.8, Diff: 0.3, Sum: 14.2]
      [GC Worker End (ms): Min: 397.3, Avg: 397.3, Max: 397.3, Diff: 0.0]
   [Code Root Fixup: 0.1 ms]
   [Code Root Purge: 0.1 ms]
   [Clear CT: 0.1 ms]
   [Other: 3.0 ms]
      [Choose CSet: 0.0 ms]
      [Ref Proc: 2.7 ms]
      [Ref Enq: 0.0 ms]
      [Redirty Cards: 0.2 ms]
      [Humongous Reclaim: 0.0 ms]
      [Free CSet: 0.0 ms]
   [Eden: 24.0M(24.0M)-&gt;0.0B(39.0M) Survivors: 0.0B-&gt;3072.0K Heap: 24.0M(256.0M)-&gt;5754.5K(256.0M)]
 [Times: user=0.02 sys=0.01, real=0.00 secs]
2015-09-30T11:13:04.343+0600: 0.868: [GC pause (G1 Evacuation Pause) (young), 0.0082908 secs]
   [Parallel Time: 5.1 ms, GC Workers: 8]
      [GC Worker Start (ms): Min: 868.3, Avg: 868.4, Max: 868.8, Diff: 0.5]
      [Ext Root Scanning (ms): Min: 0.0, Avg: 0.3, Max: 1.7, Diff: 1.7, Sum: 2.7]
      [Update RS (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 0.5]
         [Processed Buffers: Min: 0, Avg: 0.4, Max: 1, Diff: 1, Sum: 3]
      [Scan RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [Code Root Scanning (ms): Min: 0.0, Avg: 0.4, Max: 1.4, Diff: 1.4, Sum: 3.5]
      [Object Copy (ms): Min: 3.2, Avg: 4.0, Max: 4.6, Diff: 1.4, Sum: 32.1]
      [Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.1, Diff: 0.1, Sum: 0.6]
      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.1]
      [GC Worker Total (ms): Min: 4.6, Avg: 4.9, Max: 5.0, Diff: 0.5, Sum: 39.5]
      [GC Worker End (ms): Min: 873.3, Avg: 873.3, Max: 873.4, Diff: 0.0]
   [Code Root Fixup: 0.3 ms]
   [Code Root Purge: 0.1 ms]
   [Clear CT: 0.1 ms]
   [Other: 2.7 ms]
      [Choose CSet: 0.0 ms]
      [Ref Proc: 2.4 ms]
      [Ref Enq: 0.0 ms]
      [Redirty Cards: 0.1 ms]
      [Humongous Reclaim: 0.0 ms]
      [Free CSet: 0.1 ms]
   [Eden: 39.0M(39.0M)-&gt;0.0B(147.0M) Survivors: 3072.0K-&gt;6144.0K Heap: 44.6M(256.0M)-&gt;13.9M(256.0M)]
 [Times: user=0.04 sys=0.00, real=0.01 secs]
2015-09-30T11:13:04.650+0600: 1.176: [GC pause (Metadata GC Threshold) (young) (initial-mark), 0.0090083 secs]
   [Parallel Time: 5.5 ms, GC Workers: 8]
      [GC Worker Start (ms): Min: 1175.9, Avg: 1176.0, Max: 1176.0, Diff: 0.1]
      [Ext Root Scanning (ms): Min: 1.1, Avg: 1.2, Max: 1.4, Diff: 0.3, Sum: 9.4]
      [Update RS (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 1.2]
         [Processed Buffers: Min: 0, Avg: 1.1, Max: 2, Diff: 2, Sum: 9]
      [Scan RS (ms): Min: 0.1, Avg: 0.1, Max: 0.3, Diff: 0.2, Sum: 1.1]
      [Code Root Scanning (ms): Min: 0.0, Avg: 0.2, Max: 0.5, Diff: 0.5, Sum: 2.0]
      [Object Copy (ms): Min: 3.4, Avg: 3.7, Max: 3.8, Diff: 0.4, Sum: 29.3]
      [Termination (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]
      [GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.2]
      [GC Worker Total (ms): Min: 5.4, Avg: 5.4, Max: 5.5, Diff: 0.1, Sum: 43.3]
      [GC Worker End (ms): Min: 1181.4, Avg: 1181.4, Max: 1181.4, Diff: 0.0]
   [Code Root Fixup: 0.3 ms]
   [Code Root Purge: 0.0 ms]
   [Clear CT: 0.1 ms]
   [Other: 3.0 ms]
      [Choose CSet: 0.0 ms]
      [Ref Proc: 2.7 ms]
      [Ref Enq: 0.0 ms]
      [Redirty Cards: 0.1 ms]
      [Humongous Reclaim: 0.0 ms]
      [Free CSet: 0.1 ms]
   [Eden: 33.0M(147.0M)-&gt;0.0B(140.0M) Survivors: 6144.0K-&gt;13.0M Heap: 46.9M(256.0M)-&gt;20.9M(256.0M)]
 [Times: user=0.04 sys=0.00, real=0.01 secs]
2015-09-30T11:13:04.660+0600: 1.185: [GC concurrent-root-region-scan-start]
2015-09-30T11:13:04.664+0600: 1.190: [GC concurrent-root-region-scan-end, 0.0046509 secs]
2015-09-30T11:13:04.664+0600: 1.190: [GC concurrent-mark-start]
2015-09-30T11:13:04.665+0600: 1.190: [GC concurrent-mark-end, 0.0007287 secs]
2015-09-30T11:13:04.665+0600: 1.190: [GC remark 1.190: [Finalize Marking, 0.0001736 secs] 1.191: [GC ref-proc, 0.0000411 secs] 1.191: [Unloading, 0.0016740 secs], 0.0020377 secs]
 [Times: user=0.01 sys=0.00, real=0.00 secs]
2015-09-30T11:13:04.667+0600: 1.193: [GC cleanup 21M-&gt;14M(256M), 0.0004254 secs]
 [Times: user=0.01 sys=0.00, real=0.00 secs]
</code></pre><h2 id="type-of-collections">Type of Collections</h2>
<p>A simple rule to watch for on your logs is the prefix of either:</p>
<pre tabindex="0"><code>[GC ...      &lt;- Minor GC cycle (young gen)
[Full GC ... &lt;- Full GC cycle
</code></pre><p>(:exclamation:) Explicit GCs can also be identified, which is when something is invoking the <code>System.gc()</code> API. Note, this is not good thing, as
something is forcing a GC cycle to occur, rather than letting the JVM trigger this on its own (what should naturally occur).</p>
<pre tabindex="0"><code>2015-09-30T12:23:44.425+0600: 195.699: [GC (System.gc()) [PSYoungGen: 39223K-&gt;3562K(76288K)] 49685K-&gt;14032K(190464K), 0.0047880 secs] [Times: user=0.02 sys=0.00, real=0.01 secs]
2015-09-30T12:23:44.430+0600: 195.704: [Full GC (System.gc()) [PSYoungGen: 3562K-&gt;0K(76288K)] [ParOldGen: 10469K-&gt;9174K(114176K)] 14032K-&gt;9174K(190464K), [Metaspace: 25137K-&gt;25137K(1071104K)], 0.0724521 secs] [Times: user=0.38 sys=0.01, real=0.07 secs]
</code></pre><p>It is generally recommended to use the <code>-XX:+DisableExplicitGC</code> JVM option to disable forceful GC events. This will allow
the JVM to still have garbage collections, but it disables them from being triggered explicitly. The description of this option:</p>
<blockquote>
<p>By default calls to System.gc() are enabled (-XX:-DisableExplicitGC). Use -XX:+DisableExplicitGC to disable calls to System.gc(). Note that the JVM still performs garbage collection when necessary.</p></blockquote>
<h2 id="gathering-gc-logs">Gathering GC Logs</h2>
<h3 id="enabling-logs">Enabling logs</h3>
<p>With our service, let&rsquo;s go ahead and start it up with GC logging enabled:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Navigate to the root directory of this project</span>
</span></span><span class="line"><span class="cl">java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:gc.log -XX:GCLogFileSize<span class="o">=</span>5M -XX:NumberOfGCLogFiles<span class="o">=</span><span class="m">2</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> -jar java-perf-workshop-server/target/java-perf-workshop-server-1.1.0-SNAPSHOT.jar server server.yml 
</span></span></code></pre></div><h3 id="enabling-while-jvm-is-running">Enabling while JVM is running</h3>
<p>In higher versions of the JDK (9+), you can enable GC logging without having to restart the JVM (reference: <a href="https://github.com/thomasdarimont">Thomas Darimont</a>):</p>
<script src="https://gist.github.com/thomasdarimont/f89fc79491241af7a064e1b3ca2757a9.js"></script>

<h3 id="parsing-the-log">Parsing the log</h3>
<p>For parsing the logs, we are just going to show a simple approach using <a href="https://www.r-project.org/">R</a> to parse the
<code>gc.log</code> that we created. To do this, we will use the <code>stringr</code> package.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># Including stringr package for regex</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Navigating to where the project is at on my filesystem</span>
</span></span><span class="line"><span class="cl"><span class="nf">setwd</span><span class="p">(</span><span class="s">&#34;~/java-perf-workshop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Read the GC log file in</span>
</span></span><span class="line"><span class="cl"><span class="n">gc</span> <span class="o">&lt;-</span> <span class="nf">readLines</span><span class="p">(</span><span class="s">&#34;gc.log&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Regex the matches</span>
</span></span><span class="line"><span class="cl"><span class="n">matches</span> <span class="o">&lt;-</span> <span class="nf">str_match</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="s">&#34;(\\d+)K-&gt;(\\d+)K\\((\\d+)K\\),\\s(\\d+.\\d+)\\ssecs.*\\[Times\\: user=(\\d+.\\d+) sys=(\\d+.\\d+), real=(\\d+.\\d+) secs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Look at what matches, now we want to filter out the NA</span>
</span></span><span class="line"><span class="cl"><span class="n">matches</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Filter content out and convert to a data frame</span>
</span></span><span class="line"><span class="cl"><span class="n">gc.df</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="nf">na.omit</span><span class="p">(</span><span class="n">matches[</span><span class="p">,</span><span class="m">-1</span><span class="n">]</span><span class="p">),</span> <span class="n">stringsAsFactors</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add a column header to describe fields</span>
</span></span><span class="line"><span class="cl"><span class="nf">colnames</span><span class="p">(</span><span class="n">gc.df</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;HeapUsedBeforeGC_KB&#34;</span><span class="p">,</span><span class="s">&#34;HeapUsedAfterGC_KB&#34;</span><span class="p">,</span> <span class="s">&#34;HeapCapacity_KB&#34;</span><span class="p">,</span> <span class="s">&#34;GCPauseTime_Sec&#34;</span><span class="p">,</span> <span class="s">&#34;GCUserTime_Sec&#34;</span><span class="p">,</span> <span class="s">&#34;GCSysTime_Sec&#34;</span><span class="p">,</span> <span class="s">&#34;GCRealTime_Sec&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># List out the contents of the data frame</span>
</span></span><span class="line"><span class="cl"><span class="n">gc.df</span>
</span></span></code></pre></div><p>Example output:</p>
<pre tabindex="0"><code>  HeapUsedBeforeGC_KB HeapUsedAfterGC_KB HeapCapacity_KB GCPauseTime_Sec GCUserTime_Sec GCSysTime_Sec GCRealTime_Sec
1               65536              12554          251392       0.0091645           0.03          0.01           0.01
2               45883              12707          316928       0.0092271           0.03          0.01           0.01
</code></pre><p>Reminder on the types of time being collected:</p>
<ul>
<li><code>GCUserTime_Sec</code>: User space time</li>
<li><code>GCSysTime_Sec</code>: Kernel space time (operating system)</li>
<li><code>GCRealTime_Sec</code>: Complete time taken</li>
</ul>
<p>Notice that the <code>GCRealTime_Sec</code> should closely align with the <code>GCPauseTime_Sec</code> value (just rounded up). If you notice that the
<code>GCUserTime_Sec</code> is much larger than the <code>GCRealTime_Sec</code>, you can conclude that multiple threads are executing garbage collection,
as <code>GCUserTime_Sec</code> is just the sum time of all the threads.</p>
<h2 id="external-tools">External Tools</h2>
<h3 id="gc-easy">GC Easy</h3>
<p>There&rsquo;s an existing tool <a href="http://gceasy.io/">GC Easy</a> which will do GC log parsing and analysis as well.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7f540327752f6f763d88c618950bc207">6 - Containers</h1>
    <div class="lead">Learn about monitoring/troubleshooting our services when they&rsquo;re ran in a container environment.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-748dbfb27e056e8f559709df6cea6e94">6.1 - Setup</h1>
    <div class="lead">Instructions for setting up the workshop services through docker</div>
	<p>In this section we&rsquo;re going to spin up the containers needed for the workshop.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    <ul>
<li>Make sure you&rsquo;ve gone through the <a href="/docs/prereqs/">Prerequisites</a>.</li>
<li>Make sure your Docker daemon is running.</li>
<li>If this is the first time you&rsquo;re using docker, we recommend going through <a href="https://docs.docker.com/get-started/">Orientation and Setup</a> to quickly learn a few concepts.</li>
</ul>


</div>

<h2 id="building">Building</h2>
<p>The maven project uses the <a href="https://dmp.fabric8.io/">fabric8.io/docker-maven-plugin</a> to create two images:</p>
<ul>
<li><code>workshop-server</code> - the docker image for the workshop service</li>
<li><code>workshop-wiremock</code> - the docker image for the wiremock service</li>
</ul>
<p>Run <code>mvn clean package -Pdocker</code> , the <code>docker</code> profile enables the docker-maven-plugin.</p>
<p>You can view the generated images with <code>docker image ls | grep workshop</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker image ls <span class="p">|</span> grep workshop
</span></span><span class="line"><span class="cl">workshop-wiremock                                                             1.1.0-SNAPSHOT                 2cc43b2348c8   <span class="m">2</span> minutes ago   657MB
</span></span><span class="line"><span class="cl">workshop-wiremock                                                             latest                         2cc43b2348c8   <span class="m">2</span> minutes ago   657MB
</span></span><span class="line"><span class="cl">workshop-server                                                               1.1.0-SNAPSHOT                 be7cfbd0735a   <span class="m">2</span> minutes ago   659MB
</span></span><span class="line"><span class="cl">workshop-server                                                               latest                         be7cfbd0735a   <span class="m">2</span> minutes ago   659MB
</span></span></code></pre></div><h2 id="running">Running</h2>
<p>Since our Workshop Service depends on the Wiremock Service, we&rsquo;re going to use <a href="https://docs.docker.com/compose/">docker-compose</a> to create a docker environment with both our services ready to go:</p>
<p><img src="/diagrams/workshop_docker_setup.png" alt=""></p>
<p>Within the <code>java-perf-workshop</code> directory, run <code>docker-compose up</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker-compose up
</span></span><span class="line"><span class="cl">Creating network <span class="s2">&#34;java-perf-workshop_default&#34;</span> with the default driver
</span></span><span class="line"><span class="cl">Creating java-perf-workshop_wiremock_1 ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Creating java-perf-workshop_server_1   ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Attaching to java-perf-workshop_wiremock_1, java-perf-workshop_server_1
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">wiremock_1  <span class="p">|</span> port:                         <span class="m">8080</span>
</span></span><span class="line"><span class="cl">wiremock_1  <span class="p">|</span> enable-browser-proxying:      <span class="nb">false</span>
</span></span><span class="line"><span class="cl">wiremock_1  <span class="p">|</span> disable-banner:               <span class="nb">false</span>
</span></span><span class="line"><span class="cl">wiremock_1  <span class="p">|</span> no-request-journal:           <span class="nb">false</span>
</span></span><span class="line"><span class="cl">wiremock_1  <span class="p">|</span> verbose:                      <span class="nb">false</span>
</span></span><span class="line"><span class="cl">wiremock_1  <span class="p">|</span> 
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">server_1    <span class="p">|</span> INFO  <span class="o">[</span>2021-03-14 18:59:06,883<span class="o">]</span> org.eclipse.jetty.server.AbstractConnector: Started application@4c777e7b<span class="o">{</span>HTTP/1.1,<span class="o">[</span>http/1.1<span class="o">]}{</span>0.0.0.0:8080<span class="o">}</span>
</span></span><span class="line"><span class="cl">server_1    <span class="p">|</span> INFO  <span class="o">[</span>2021-03-14 18:59:06,892<span class="o">]</span> org.eclipse.jetty.server.AbstractConnector: Started admin@5f038248<span class="o">{</span>HTTP/1.1,<span class="o">[</span>http/1.1<span class="o">]}{</span>0.0.0.0:8081<span class="o">}</span>
</span></span><span class="line"><span class="cl">server_1    <span class="p">|</span> INFO  <span class="o">[</span>2021-03-14 18:59:06,892<span class="o">]</span> org.eclipse.jetty.server.Server: Started @4358ms
</span></span></code></pre></div><p>In another terminal, you can check the status of the containers by running <code>docker ps</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker ps
</span></span><span class="line"><span class="cl">CONTAINER ID   IMAGE                      COMMAND                  CREATED          STATUS          PORTS                              NAMES
</span></span><span class="line"><span class="cl">c9aeb5375f79   workshop-server:latest     <span class="s2">&#34;/bin/sh -c &#39;java -j…&#34;</span>   <span class="m">52</span> seconds ago   Up <span class="m">50</span> seconds   0.0.0.0:8080-8081-&gt;8080-8081/tcp   java-perf-workshop_server_1
</span></span><span class="line"><span class="cl">6b1522e7acb9   workshop-wiremock:latest   <span class="s2">&#34;/bin/sh -c &#39;java -j…&#34;</span>   <span class="m">52</span> seconds ago   Up <span class="m">51</span> seconds                                      java-perf-workshop_wiremock_1
</span></span></code></pre></div><p>Our workshop service container is exposing port <code>8080</code> and mapping it into the container&rsquo;s <code>8080</code>. Verify that your setup is working by visiting: <a href="http://localhost:8080/search?q=docker">http://localhost:8080/search?q=docker</a>.</p>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll learn how to enable Java Monitoring Tooling to work with containers.
</p>
        <a href="https://jvmperf.net/docs/containers/java_monitoring/">Java Monitoring Tooling</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-634bf2ba5287d43935922a4fc1edab6a">6.2 - Java Monitoring Tooling</h1>
    <div class="lead">Instructions for enabling remote tooling on our JVM</div>
	<p>In this section we&rsquo;re going to configure our container to enable remote tooling.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Note</h4>

    <ul>
<li>Make sure you&rsquo;ve gone through the <a href="/docs/prereqs/">Prerequisites</a>.</li>
<li>Make sure your Docker daemon is running.</li>
<li>If this is the first time you&rsquo;re using docker, we recommend going through <a href="https://docs.docker.com/get-started/">Orientation and Setup</a> to quickly learn a few concepts.</li>
</ul>


</div>

<h2 id="remote-monitoring">Remote Monitoring</h2>
<p>In previous sections of the workshop, we ran all our tooling without any configuration. In previous versions of Java you would have had to configure things even for local monitoring, this is no longer the case with Java 6+:</p>
<blockquote>
<p>Any application that is started on the Java SE 6 platform will support the Attach API, and so will automatically be made available for local monitoring and management when needed.</p></blockquote>
<p>Since the docker-compose network and containers are ran separate from our host (consider them a different machine), we need to enable <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/management/agent.html">remote monitoring and management</a>.</p>
<p><img src="/diagrams/jmx_remote_docker.png" alt=""></p>
<h3 id="properties">Properties</h3>
<p>We&rsquo;ll set the following properties as a <code>JAVA_OPTS</code> environment variable when we start our workshop server container:</p>
<ul>
<li>The <code>JMX remote port</code> to <code>8082</code>: <code>-Dcom.sun.management.jmxremote.port=8082</code></li>
<li>The RMI registry port also set to <code>8082</code>: <code>-Dcom.sun.management.jmxremote.rmi.port=8082</code></li>
<li>Disabling for both the registry and jmx: <code>-Dcom.sun.management.jmxremote.registry.ssl=false</code> and <code>-Dcom.sun.management.jmxremote.ssl=false</code></li>
<li>Accept connections not from localhost: <code>-Dcom.sun.management.jmxremote.local.only=false</code>
<ul>
<li>Since the machine we are connecting from will not be in the container network, we need to allow non localhost connections.</li>
</ul>
</li>
<li>The host name for the <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/rmi/javarmiproperties.html">RMI server</a> will be set to <code>127.0.0.1</code>. The default value for this will be the container&rsquo;s IP address, which we are overriding.</li>
</ul>
<p>Set these values as an <code>environment</code> property on your workshop container:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">workshop-server:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">JAVA_OPTS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        -Dcom.sun.management.jmxremote.port=8082
</span></span></span><span class="line"><span class="cl"><span class="s2">        -Dcom.sun.management.jmxremote.rmi.port=8082
</span></span></span><span class="line"><span class="cl"><span class="s2">        -Dcom.sun.management.jmxremote.registry.ssl=false
</span></span></span><span class="line"><span class="cl"><span class="s2">        -Dcom.sun.management.jmxremote.authenticate=false
</span></span></span><span class="line"><span class="cl"><span class="s2">        -Dcom.sun.management.jmxremote.ssl=false
</span></span></span><span class="line"><span class="cl"><span class="s2">        -Dcom.sun.management.jmxremote.local.only=false
</span></span></span><span class="line"><span class="cl"><span class="s2">        -Djava.rmi.server.hostname=127.0.0.1
</span></span></span><span class="line"><span class="cl"><span class="s2">      &#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span></code></pre></div><h2 id="test-our-setup">Test Our Setup</h2>
<p>Spin up your services again with <code>docker-compose up</code>. Once the services are started, use <code>docker ps</code> to check the open ports on the workshop server. Notice that <code>8082</code> is now mapped as well.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker ps
</span></span><span class="line"><span class="cl">CONTAINER ID   IMAGE                      COMMAND                  CREATED          STATUS          PORTS                              NAMES
</span></span><span class="line"><span class="cl">44d4a1ebedef   workshop-server:latest     <span class="s2">&#34;/bin/sh -c &#39;java </span><span class="nv">$J</span><span class="s2">…&#34;</span>   <span class="m">39</span> seconds ago   Up <span class="m">37</span> seconds   0.0.0.0:8080-8082-&gt;8080-8082/tcp   java-perf-workshop_server_1
</span></span></code></pre></div><h3 id="jdk-mission-control">JDK Mission Control</h3>
<p>We&rsquo;ll use JDK Mission Control to create a JMX Connection.</p>
<p>Open JDK Mission Control. Notice that the JVM Browser no longer shows the two services (since they no longer are running on the local host):</p>
<p><img src="/containers/jmx/empty_browser.png" alt=""></p>
<p>Create a new JMX Connection using <code>0.0.0.0</code> and <code>8082</code> as the host and port:</p>
<p><img src="/containers/jmx/new_connection.png" alt=""></p>
<p>With our setup, we can connect with other addresses as well:</p>
<ul>
<li><code>127.0.0.1</code></li>
<li><code>localhost</code> (since we are exposing port 8082 on the container as port 8082 on the local host)</li>
<li>Our wifi/ethernet IP address, which you can find under the <code>en0</code> interface using <code>ifconfig/ipconfig</code>:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ifconfig
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">en0: <span class="nv">flags</span><span class="o">=</span>8863&lt;UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST&gt; mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">  ether 8c:85:90:ba:52:10 
</span></span><span class="line"><span class="cl">  inet6 fe80::1862:95fe:55e7:284e%en0 prefixlen <span class="m">64</span> secured scopeid 0x9 
</span></span><span class="line"><span class="cl">  inet 192.168.1.189 netmask 0xffffff00 broadcast 192.168.1.255
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div></li>
</ul>
<p><img src="/containers/jmx/all_jmx_servers.png" alt=""></p>
<p> </p>
  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, we'll learn about some Docker tooling.
</p>
        <a href="https://jvmperf.net/docs/containers/docker_monitoring/">Docker Tooling</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c470bf618fcbdd51c44b1b1135f55896">6.3 - Docker Tooling</h1>
    <div class="lead">Learn about Docker tooling to inspect our running containers</div>
	  <br/>
  <div class="card mb-3" style="width: 80%;">
      <div class="card-header text-white border-info bg-info">
          <i class="fas fa-arrow-alt-circle-right"></i>&nbsp;&nbsp;Up Next</div>
      <div class="card-body">
        <p class="card-text">
In the next section, X
</p>
        <a href="https://jvmperf.net/docs/containers/_references/">References</a></i>
      </div>
  </div>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6362126ba5f5128b262a9fb88d5015e8">6.4 - References</h1>
    <div class="lead">Collection of useful references used to build this guide.</div>
	<ul>
<li><a href="https://docs.docker.com/get-started/">Docker Orientation and Setup</a></li>
<li>JMX
<ul>
<li><a href="https://github.com/cstroe/java-jmx-in-docker-sample-app/blob/master/README.md#java-jmx-with-docker">JMX with Docker</a></li>
<li><a href="http://blog.bytecode.tech/my-notes/jmx-over-rmi/">JMX over RMI</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/management/agent.html">Monitoring Reference</a></li>
</ul>
</li>
</ul>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/cchesser/java-perf-workshop" aria-label="GitHub">
      <i class="fa-brands fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2015&ndash;2025
    <span class="td-footer__authors"><a href="/contributors/">jvmperf Contributors</a> <br /> Oracle and Java are registered trademarks of Oracle and/or its affiliates. Other names may be trademarks of their respective owners.</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <style>
.markmap > svg {
  width: 100%;
  height: 300px;
}
</style>
<script>
window.markmap = {
  autoLoader: {
      manual: true,
      onReady() {
        const { autoLoader, builtInPlugins } = window.markmap;
        autoLoader.transformPlugins = builtInPlugins.filter(plugin => plugin.name !== 'prism');
      },
  },
};
</script>
<script src="https://cdn.jsdelivr.net/npm/markmap-autoloader"></script>
<script src='/js/deflate.js'></script>
<script src="/js/main.min.f1db9b7a56d196a6fffb9680eca1a6ee7fa18dae438d020141d40b4e68f117a9.js" integrity="sha256-8dubelbRlqb/&#43;5aA7KGm7n&#43;hja5DjQIBQdQLTmjxF6k=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
